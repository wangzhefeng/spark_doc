

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-cn" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-cn" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Spark Structured API &mdash; Spark 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spark SQL" href="SparkSQL.html" />
    <link rel="prev" title="Spark 介绍" href="Spark-Introduction.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Spark
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Scala</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scala/scala-helloworld.html">Scala 入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scala/scala.html">Scala Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scala/scala-OOP.html">Scala OOP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scala/scala-features.html">Scala 特点</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scala/scala-set-object.html">Scala Set</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scala/maven.html">Maven</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scala/sbt.html">sbt</a></li>
</ul>
<p class="caption"><span class="caption-text">spark-book</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Spark-Introduction.html">Spark 介绍</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Spark Structured API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#header-n3">1.Spark Structured API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dataset-dataframe">1.1 Dataset 和 DataFrame</a></li>
<li class="toctree-l3"><a class="reference internal" href="#schema">1.2 Schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="#structured-spark-types">1.3 Structured Spark Types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dataframe-dataset">1.3.1 DataFrame 与 Dataset 的比较</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">1.3.2 列</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">1.3.3 行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spark">1.3.4 Spark 类型</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#structured-api-execution">1.4 Structured API Execution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#logical-planning">1.4.1 Logical Planning</a></li>
<li class="toctree-l4"><a class="reference internal" href="#physical-planning">1.4.2 Physical Planning</a></li>
<li class="toctree-l4"><a class="reference internal" href="#execution">1.4.3 Execution</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dataframe">2.DataFrame</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#schemas">2.1 Schemas</a></li>
<li class="toctree-l3"><a class="reference internal" href="#columns-expressions">2.2 Columns 和 Expressions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#columns">2.2.1 Columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="#expressions">2.2.2 Expressions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#records-rows">2.3 Records 和 Rows</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rows">2.3.1 创建 Rows</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dataframe-transformations">2.4 DataFrame transformations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#header-n327">2.4.1 创建 DataFrame</a></li>
<li class="toctree-l4"><a class="reference internal" href="#select-selectexpr">2.4.2 select 和 selectExpr</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spark-literals">2.4.3 Spark 字面量(Literals)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#columns-columns">2.4.4 增加 Columns、 重命名 Columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reserved-characters-and-keywords">2.4.5 转义字符和关键字(reserved characters and keywords)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#case-sensitivity">2.4.6 Case Sensitivity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n384">2.4.7 删除 Columns</a></li>
<li class="toctree-l4"><a class="reference internal" href="#columns-cast">2.4.8 改变 Columns 的类型(cast)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n403">2.4.9 筛选行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unique-distinct">2.4.10 获取不重复(Unique/Distinct)的行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n412">2.4.11 随机抽样</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n415">2.4.12 随机分割</a></li>
<li class="toctree-l4"><a class="reference internal" href="#concatenating-appending">2.4.13 拼接(Concatenating)和追加(Appending)行</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n428">2.4.14 行排序</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limit">2.4.15 Limit</a></li>
<li class="toctree-l4"><a class="reference internal" href="#repartiton-and-coalesce">2.4.16 Repartiton(重新分区) and Coalesce(分区聚合)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#collecting-rows-to-the-driver">2.4.17 Collecting Rows to the Driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#converting-spark-types">2.4.18 Converting Spark Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#boolean">2.4.19 Boolean</a></li>
<li class="toctree-l4"><a class="reference internal" href="#number">2.4.20 Number</a></li>
<li class="toctree-l4"><a class="reference internal" href="#string">2.4.21 String</a></li>
<li class="toctree-l4"><a class="reference internal" href="#date-and-timestamp">2.4.22 Date and Timestamp</a></li>
<li class="toctree-l4"><a class="reference internal" href="#null-data">2.4.23 Null Data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ordering">2.4.24 Ordering</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-types">2.4.25 复杂类型 Complex Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#json">2.4.26 Json</a></li>
<li class="toctree-l4"><a class="reference internal" href="#user-defined-functions-udf">2.4.27 用户自定义函数 User-Defined Functions(UDF)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#aggregations">2.4.28 Aggregations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#joins">2.4.29 Joins</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#sql">3.SQL</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tables">3.1 表 (tables)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#spark-sql">3.1.1 Spark SQL 创建表</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n1018">3.1.2 Spark SQL 创建外部表</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n1019">3.1.3 Spark SQL 插入表</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spark-sql-describing-matadata">3.1.4 Spark SQL Describing 表 Matadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#spark-sql-refreshing-matadata">3.1.5 Spark SQL Refreshing 表 Matadata</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n1030">3.1.6 Spark SQL 删除表</a></li>
<li class="toctree-l4"><a class="reference internal" href="#caching">3.1.7 Caching 表</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#views">3.2 视图 (views)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#header-n1049">3.2.1 创建视图</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n1057">3.2.2 删除视图</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dataframe-view">3.2.3 DataFrame 和 View</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#databases">3.3 数据库 (databases)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#header-n1066">3.3.1 创建数据库</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n1067">3.3.2 配置数据库</a></li>
<li class="toctree-l4"><a class="reference internal" href="#header-n1068">3.3.3 删除数据库</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#header-n1070">3.4 数据查询语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="#header-n1104">3.5 其他</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#dataset">4.DataSet</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#header-n1108">4.1 创建 DataSet</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#java-encoders">Java: <code class="docutils literal notranslate"><span class="pre">Encoders</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#scala-case-class">Scala: <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#actions">4.2 Actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transformations">4.3 Transformations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dataframe-transformation">DataFrame 上的 Transformation 操作</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dataset-transformation">DataSet 特有的 Transformation 操作</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#header-n1149">4.4 Joins</a></li>
<li class="toctree-l3"><a class="reference internal" href="#grouping-and-aggregations">4.5 Grouping and Aggregations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="SparkSQL.html">Spark SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spark-Data-Source.html">Spark 数据源 (Data Sources) I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spark-Low-Level-API.html">Spark Low-Level API</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spark-APP.html">Spark 应用程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spark-Structured-Streaming.html">Spark Structured Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spark-MLlib.html">Spark MLlib</a></li>
</ul>
<p class="caption"><span class="caption-text">spark-apache-org</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../spark-apache-org/Spark.html">Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-apache-org/Spark-shell.html">Spark Shell</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-apache-org/Spark-SQL.html">Spark SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-apache-org/Spark-RDD.html">Spark RDD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-apache-org/Spark-MLlib.html">Spark MLlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-apache-org/Spark-Structured-Streaming.html">Spark Structured Streaming</a></li>
</ul>
<p class="caption"><span class="caption-text">spark-api</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../spark-api/pyspark-api.html">pyspark API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-api/pyspark-sql-api.html">pyspark API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-api/spark-api-scala.html">spark(scala) API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-api/sparksql-api-scala.html">Spark SQL</a></li>
</ul>
<p class="caption"><span class="caption-text">spark-topic</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../spark-dependence.html">Spark 依赖</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spark-partitions.html">Spark 分区</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Spark</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Spark Structured API</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/spark-book/Spark-Structured-API.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="spark-structured-api">
<span id="header-n0"></span><h1>Spark Structured API<a class="headerlink" href="#spark-structured-api" title="Permalink to this headline">¶</a></h1>
<p>Spark 结构化 API 是处理各种数据类型的工具，可处理非结构化的日志文件、半结构化的 CSV 文件，以及高度结构化的 Parquet 文件。</p>
<p>Spark 结构化 API 指以下三种核心分布式集合类型的 API:</p>
<ul class="simple">
<li><p>Dataset</p></li>
<li><p>DataFrame</p></li>
<li><p>SQL Table 和 View</p></li>
</ul>
<p>大多数结构化 API 均适用于批处理和流处理，这意味着使用结构化 API 编写代码时，几乎不费吹灰之力就可以从批处理程序转换为流处理程序，反之亦然.</p>
<div class="section" id="header-n3">
<span id="id1"></span><h2>1.Spark Structured API<a class="headerlink" href="#header-n3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Spark is a <strong>distributed programming model</strong> in which the user
specifies <code class="docutils literal notranslate"><span class="pre">transformations</span></code>.</p>
<ul>
<li><p>Multiple <code class="docutils literal notranslate"><span class="pre">transformations</span></code> build up a <strong>directed acyclic graph</strong>
of instructions.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">action</span></code> begins the process of executing that graph of
instructions, as a single <strong>job</strong>, by breaking it down into
<strong>stages</strong> and <strong>tasks</strong> to execute across the <strong>cluster</strong>.</p></li>
</ul>
</li>
<li><p>The logical structures that we manipulate with <code class="docutils literal notranslate"><span class="pre">transformations</span></code>
and <code class="docutils literal notranslate"><span class="pre">actions</span></code> are <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and <code class="docutils literal notranslate"><span class="pre">Datasets</span></code>.</p>
<ul>
<li><p>To create a new DataFrame and Dataset, you call a
<code class="docutils literal notranslate"><span class="pre">transformation</span></code>.</p></li>
<li><p>To start computation(cluster computation) or convert to native
language types(spark types), you call an <code class="docutils literal notranslate"><span class="pre">action</span></code>.</p></li>
</ul>
</li>
</ul>
<div class="section" id="dataset-dataframe">
<span id="header-n19"></span><h3>1.1 Dataset 和 DataFrame<a class="headerlink" href="#dataset-dataframe" title="Permalink to this headline">¶</a></h3>
<p>Spark 支持两种结构化集合类型：Dataset 和 DataFrame.</p>
<p>DataFrames and Datasets are distributed table-like with well-defined
rows and columns.</p>
<ul class="simple">
<li><p>Each column must have the same number of rows as all the other
columns(可以用 <code class="docutils literal notranslate"><span class="pre">null</span></code> 来指定缺失值);</p></li>
<li><p>Each column has type information that must be consistent for every
row in the collection;</p></li>
</ul>
<p>DataFrame and Datasets represent <strong>immutable</strong>, <strong>lazily evaluated
plans</strong> that specify what operations to apply to data residing at a
location to generate some output. When we perform an action on a
DataFrame, we instruct Spark to perform the actual transformations and
return the result.</p>
</div>
<div class="section" id="schema">
<span id="header-n28"></span><h3>1.2 Schema<a class="headerlink" href="#schema" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><dl class="simple">
<dt>A schema defines the column names and types of a DataFrame, define schemas:</dt><dd><ul>
<li><p>manually</p></li>
<li><p>read a schema from a data source(schema on read)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="structured-spark-types">
<span id="header-n35"></span><h3>1.3 Structured Spark Types<a class="headerlink" href="#structured-spark-types" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Spark is effectively a <strong>programming language</strong> of its own.</p></li>
<li><p>Spark uses an engine called <strong>Catalyst</strong> that maintains its own
type information through the planning and processing of work. This
open up a wide variety of execution optimizations that make
significant differences.</p></li>
<li><p>Even if we use Spark’s Structured APIs from Python or R, the
majority of our manipulations will operate strictly on <strong>Spark
types</strong>, not Python or R types.</p></li>
</ul>
<div class="section" id="dataframe-dataset">
<h4>1.3.1 DataFrame 与 Dataset 的比较<a class="headerlink" href="#dataframe-dataset" title="Permalink to this headline">¶</a></h4>
<dl class="simple">
<dt>Spark 结构化 API 包含两类 API，即非类型化的 DataFrame 和非类型化的 Dataset</dt><dd><ul class="simple">
<li><p>DataFrame 是无类型的是因为它们其实是有类型的，只是 Spark 完全负责维护它们的类型，仅在运行时检查这些类型是否与 schema 中指定的类型一致.</p></li>
<li><p>Dataset 在编译时就会检查类型是否符合规范，Dataset 仅适用于基于 Java 虚拟机(JVM) 的语言(比如 Scala 和 Java)，并通过 case 类或 Java beans 指定类型.</p></li>
</ul>
</dd>
</dl>
<p>在 Scala 版本中的 Spark 中，DataFrame 就是一些 Row 类型的 Dataset 的集合。Row 类型是 Spark 用于支持内存计算而优化的数据格式。这种格式有利于高效计算。因为它避免使用会带来昂贵垃圾回收开销和对象实例化开销的 JVM 类型，而是基于自己的内部格式运行，所以不会产生这种开销.</p>
<p>Python 版本和 R 语言版本的 Spark 并不支持 Dataset，所有东西都是 DataFrame，这样就可以使用这种优化的数据格式进行计算处理.</p>
</div>
<div class="section" id="id2">
<h4>1.3.2 列<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Spark 的列表示一个简单类型，或者一个复杂类型，或者空值 <code class="docutils literal notranslate"><span class="pre">null</span></code>. Spark 记录所有这些类型的信息并提供多种转换方法.</p>
<p>简单来说，可以将 Spark 列想象为一个数据表的列即可.</p>
</div>
<div class="section" id="id3">
<h4>1.3.3 行<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>Spark 的一行对应一个数据记录. DataFrame 中的每条记录都必须是 <code class="docutils literal notranslate"><span class="pre">Row</span></code> 类型，可以通过 SQL 手动创建、从 RDD 提取、从数据源手动创建一个行.</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">toDF</span><span class="o">().</span><span class="n">collect</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="spark">
<h4>1.3.4 Spark 类型<a class="headerlink" href="#spark" title="Permalink to this headline">¶</a></h4>
<dl>
<dt><strong>实例化或声明一个特定类型的列:</strong></dt><dd><ul class="simple">
<li><p>Scala version:</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>
<span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="nc">ByteType</span>
</pre></div>
</div>
</dd>
<dt><strong>实例化或声明一个特定类型的列:</strong></dt><dd><ul class="simple">
<li><p>Java version:</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Java</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.DataTypes</span><span class="p">;</span>
<span class="n">ByteType</span> <span class="n">a</span> <span class="o">=</span> <span class="n">DataTypes</span><span class="p">.</span><span class="na">ByteType</span><span class="p">;</span>
</pre></div>
</div>
</dd>
<dt><strong>实例化或声明一个特定类型的列:</strong></dt><dd><ul class="simple">
<li><p>Python version:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">ByteType</span><span class="p">()</span>
</pre></div>
</div>
</dd>
<dt><strong>Spark Internal Types:</strong></dt><dd><ul class="simple">
<li><p>Python 类型参考表：</p></li>
</ul>
</dd>
</dl>
<table class="docutils align-default">
<colgroup>
<col style="width: 44%" />
<col style="width: 56%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<dl class="simple">
<dt><strong>Spark Internal Types:</strong></dt><dd><ul class="simple">
<li><p>Scala 类型参考表：</p></li>
</ul>
</dd>
</dl>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Spark数据类型</p></th>
<th class="head"><p>Scala数据类型</p></th>
<th class="head"><p>创建数据类型实例的API</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ByteType</p></td>
<td><p>Byte</p></td>
<td><p>ByteType</p></td>
</tr>
<tr class="row-odd"><td><p>ShortType</p></td>
<td><p>Short</p></td>
<td><p>ShortType</p></td>
</tr>
<tr class="row-even"><td><p>IntegerType</p></td>
<td><p>Int</p></td>
<td><p>IntegerType</p></td>
</tr>
<tr class="row-odd"><td><p>LongType</p></td>
<td><p>Long</p></td>
<td><p>LongType</p></td>
</tr>
<tr class="row-even"><td><p>FloatType</p></td>
<td><p>Float</p></td>
<td><p>FloatType</p></td>
</tr>
<tr class="row-odd"><td><p>DoubleType</p></td>
<td><p>Double</p></td>
<td><p>DoubleType</p></td>
</tr>
<tr class="row-even"><td><p>DecimalType</p></td>
<td><p>java.math.BitgDecimal</p></td>
<td><p>DecimalType</p></td>
</tr>
<tr class="row-odd"><td><p>StringType</p></td>
<td><p>String</p></td>
<td><p>StringType</p></td>
</tr>
<tr class="row-even"><td><p>BinaryType</p></td>
<td><p>Array[Byte]</p></td>
<td><p>BinaryType</p></td>
</tr>
<tr class="row-odd"><td><p>BooleanType</p></td>
<td><p>Boolean</p></td>
<td><p>BooleanType</p></td>
</tr>
<tr class="row-even"><td><p>TimestampType</p></td>
<td><p>java.sql.Timestamp</p></td>
<td><p>TimestampType</p></td>
</tr>
<tr class="row-odd"><td><p>DateType</p></td>
<td><p>java.sql.Date</p></td>
<td><p>DateType</p></td>
</tr>
<tr class="row-even"><td><p>ArrayType</p></td>
<td><p>scala.collection.Seq</p></td>
<td><p>ArrayType(elementType
,
[containsNull =
true])</p></td>
</tr>
<tr class="row-odd"><td><p>MapType</p></td>
<td><p>scala.collection.Map</p></td>
<td><p>MapType(keyType,
valueType,
[valueContainsNull =
true])</p></td>
</tr>
<tr class="row-even"><td><p>StructType</p></td>
<td><p>org.apache.spark.sql.
Row</p></td>
<td><p>StructType(field)</p></td>
</tr>
<tr class="row-odd"><td><p>StructField</p></td>
<td><p>Int for a StructField
with the data type
IntegerType,…</p></td>
<td><p>StructField(name,
dataType, [nullable =
true])</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="structured-api-execution">
<span id="header-n118"></span><h3>1.4 Structured API Execution<a class="headerlink" href="#structured-api-execution" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt>How code is actually executed across a cluster ?</dt><dd><ul class="simple">
<li><p>1.Write DataFrame/Dataset/SQL Code;</p></li>
<li><p>2.If vaild code, Spark converts Code to a <strong>Logistic Plan</strong>;</p></li>
<li><p>3.Spark transforms this <strong>Logistic Plan</strong> to <strong>Physical Plan</strong>, checking for optimizations along the way;</p></li>
<li><p>4.Spark then executes this <strong>Physical Plan</strong>(RDD manipulations) on the cluster;</p></li>
</ul>
</dd>
</dl>
<p>To execute code, must write code. This code is then submitted to Spark
either through the <code class="docutils literal notranslate"><span class="pre">console</span></code> or via a <code class="docutils literal notranslate"><span class="pre">submitted</span> <span class="pre">job</span></code>. This code the passes
through the <strong>Catalyst Optimizer</strong>, which decides how the code should be
executed and lays out a plan for doing so before, finally, the code is
run and the result is returned to the user.</p>
<img alt="Catalyst优化器" src="../_images/Catalyst优化器.png" />
<div class="section" id="logical-planning">
<span id="header-n134"></span><h4>1.4.1 Logical Planning<a class="headerlink" href="#logical-planning" title="Permalink to this headline">¶</a></h4>
<dl class="simple">
<dt>Spark 结构化 API 执行的第一阶段是获取用户代码，并将其转换为逻辑计划.</dt><dd><ul class="simple">
<li><p>转换后的逻辑计划仅代表一组抽象转换，并不涉及驱动器和执行器，它只是将用户的表达式集合转换为最优的版本。它通过将用户代码转换为未解析的逻辑计划来实现这一点.</p></li>
<li><p>从用户代码转换来的逻辑计划并没有被解析，因为虽然用户的代码可能是有效的，但它引用的表可能不存在. Spark 使用 <code class="docutils literal notranslate"><span class="pre">catalog</span></code> (所有表和 DataFrame 信息的存储库) 在分析器中解析列和表格. 如果目录中不存在所需的表格或列名称，分析器可能会拒绝该未解析的逻辑计划.</p></li>
<li><p>如果分析器可以解析它，结果将通过 <code class="docutils literal notranslate"><span class="pre">Catalyst</span> <span class="pre">优化器</span></code> 尝试通过下推谓词或选择操作来优化逻辑计划. 用户也可以扩展 Catalyst 优化器来支持自己的特定领域优化策略.</p></li>
</ul>
</dd>
</dl>
<img alt="结构化API的逻辑计划" src="../_images/结构化的逻辑计划.png" />
</div>
<div class="section" id="physical-planning">
<span id="header-n155"></span><h4>1.4.2 Physical Planning<a class="headerlink" href="#physical-planning" title="Permalink to this headline">¶</a></h4>
<dl class="simple">
<dt>在成功创建 <code class="docutils literal notranslate"><span class="pre">优化的逻辑计划</span></code> 后，Spark 开始 <code class="docutils literal notranslate"><span class="pre">执行物理计划流程</span></code> 。物理计划（通常称为 Spark 计划）通过生成不同的物理执行策略，并通过 <code class="docutils literal notranslate"><span class="pre">代价模型</span></code> 进行比较分析，从而指定如何在集群上执行逻辑计划.</dt><dd><ul class="simple">
<li><p>例如：执行一个连接操作就会涉及代价比较，它通过分析数据表的物理属性(表的大小或分区的大小)，对不同的物理执行策略进行代价比较，选择合适的物理执行计划.</p></li>
<li><p>物理执行计划产生一系列的 RDD 和转换操作，这就是 Spark 被称为编译器的原因，因为它将对 DataFrame、Dataset 和 SQL 中的查询操作为用户编译一系列 RDD 的转换操作.</p></li>
</ul>
</dd>
</dl>
<img alt="物理计划流程" src="../_images/物理计划流程.png" />
</div>
<div class="section" id="execution">
<span id="header-n166"></span><h4>1.4.3 Execution<a class="headerlink" href="#execution" title="Permalink to this headline">¶</a></h4>
<p>在选择一个物理计划时，Spark 将所有代码运行在 Spark 的底层编程接口 RDD 上.
Spark 在运行时进一步优化，生成可以在执行期间优化任务或阶段的本地 Java 字节码，
最终将结果返回给用户.</p>
</div>
</div>
</div>
<div class="section" id="dataframe">
<span id="header-n179"></span><h2>2.DataFrame<a class="headerlink" href="#dataframe" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>A DataFrame consists of a series of <strong>records</strong> (like row in a table), that are of type <code class="docutils literal notranslate"><span class="pre">Row</span></code>, and a number of <strong>columns</strong> (like columns in a spreadsheet) that represent a computation expression that can be preformed on each individual record in the Dataset.</dt><dd><ul class="simple">
<li><p>Schema 定义了 DataFrame 中每一列数据的名字和数据类型.</p></li>
<li><p>DataFrame Partitioning 定义了 DataFrame 和 Dataset 在集群上的物理分布结构.</p></li>
<li><p>Partitioning schema 定义了 partition 的分配方式，可以自定义分区，也可以采取随机分配方式.</p></li>
<li><p>DataFrame operations:
-  聚合(aggregation)
-  窗口函数(window function)
-  连接(join)</p></li>
</ul>
</dd>
</dl>
<p><strong>示例:</strong></p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span>
   <span class="o">.</span><span class="n">read</span>
   <span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;josn&quot;</span><span class="o">)</span>
   <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="o">)</span>

<span class="c1">// 查看DataFrame的schema</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span> \
   <span class="o">.</span><span class="n">read</span> \
   <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="p">)</span>

<span class="c1"># 查看DataFrame的schema</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<div class="section" id="schemas">
<span id="header-n201"></span><h3>2.1 Schemas<a class="headerlink" href="#schemas" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Schema 定义了 DataFrame 中每一列数据的 <code class="docutils literal notranslate"><span class="pre">名字</span></code> 和 <code class="docutils literal notranslate"><span class="pre">类型</span></code></p></li>
<li><p>为 DataFrame 设置 Schema 有两种方式:</p>
<ul>
<li><p>使用数据源已有的 Schema (schema-on-read, 读时模式)</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">StructType</span></code>, <code class="docutils literal notranslate"><span class="pre">StructField</span></code> 自定义 DataFrame 的 Schema</p></li>
</ul>
</li>
<li><p>一个 Schema 是由许多字段(field)构成的 <code class="docutils literal notranslate"><span class="pre">StructType</span></code>, 这些字段即为 <code class="docutils literal notranslate"><span class="pre">StructField</span></code>，具有名称、类型、布尔标志(该标志指定该列是否可以包含缺失值或空值)，并且用户可指定与该列关联的元数据(metadata). 元数据存储着有关此列的信息(Spark 在 MLlib 库中使用此功能).</p>
<ul>
<li><p>如果程序在运行时，DataFrame 中 column 的 type 没有与预先设定的 Schema 相匹配，Spark 就会抛出错误</p></li>
</ul>
</li>
</ul>
<p>(1)使用数据源已有的 Schema (schema-on-read)</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;json&quot;</span><span class="o">)</span>
   <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="o">)</span>
   <span class="o">.</span><span class="n">schema</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="p">)</span>
   <span class="o">.</span><span class="n">schema</span>
</pre></div>
</div>
</div></blockquote>
<p>(2)使用 <code class="docutils literal notranslate"><span class="pre">StructType</span></code>, <code class="docutils literal notranslate"><span class="pre">StructField</span></code> 自定义 DataFrame 的 Schema</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types.</span><span class="o">{</span><span class="nc">StructField</span><span class="o">,</span> <span class="nc">StructType</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types.Metadata</span>

<span class="k">val</span> <span class="n">myManualSchema</span> <span class="k">=</span> <span class="nc">StructType</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span>
   <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="kc">true</span><span class="o">),</span>
   <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="kc">true</span><span class="o">),</span>
   <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;COUNT&quot;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="nc">Metadata</span><span class="o">.</span><span class="n">fromJson</span><span class="o">(</span><span class="s">&quot;{\&quot;hello\&quot;: \&quot;world\&quot;}&quot;</span><span class="o">))</span>
<span class="o">))</span>

<span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;json&quot;</span><span class="o">)</span>
   <span class="o">.</span><span class="n">schema</span><span class="o">(</span><span class="n">myManualSchema</span><span class="o">)</span>
   <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">LongType</span>

<span class="n">myManualSchema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
   <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
   <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
   <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;COUNT&quot;</span><span class="p">,</span> <span class="n">LongType</span><span class="p">(),</span> <span class="kc">False</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hello&quot;</span><span class="p">:</span><span class="s2">&quot;world&quot;</span><span class="p">})</span>
<span class="p">])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">schema</span><span class="p">(</span><span class="n">myManualSchema</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="columns-expressions">
<span id="header-n223"></span><h3>2.2 Columns 和 Expressions<a class="headerlink" href="#columns-expressions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Spark 中的 <code class="docutils literal notranslate"><span class="pre">columns</span></code> 就像 spreadsheet, R dataframe, Pandas DataFrame 中的列一样, 可以对 Spark 中的 <code class="docutils literal notranslate"><span class="pre">columns</span></code> 进行 <strong>选择，操作，删除</strong> 等操作，这些操作表现为 <code class="docutils literal notranslate"><span class="pre">expression</span></code> 的形式</p></li>
<li><p>在 Spark 中来操作 <code class="docutils literal notranslate"><span class="pre">column</span></code> 中的内容必须通过 Spark DataFrame 的 transformation 进行</p></li>
</ul>
<div class="section" id="columns">
<span id="header-n230"></span><h4>2.2.1 Columns<a class="headerlink" href="#columns" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p>有很多种方法来创建和引用 DataFrame 中的 column:</p>
<ul class="simple">
<li><p>函数(function):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">col()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">column()</span></code></p></li>
</ul>
</li>
<li><p>符号(Scala独有的功能，无性能优化):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">$&quot;myColumn&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'myColumn</span></code></p></li>
</ul>
</li>
<li><p>DataFrame 的方法(explicit column references):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">df.col(&quot;myColumn&quot;)</span></code></p></li>
</ul>
</li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.function.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">column</span><span class="o">}</span>

<span class="n">col</span><span class="o">(</span><span class="s">&quot;someColumnName&quot;</span><span class="o">)</span>
<span class="n">column</span><span class="o">(</span><span class="s">&quot;someColumnName&quot;</span><span class="o">)</span>
<span class="n">$</span><span class="s">&quot;someColumnName&quot;</span>
<span class=" -Symbol">&#39;someColumnName</span>
<span class="n">df</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;someColumnName&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.function</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">column</span>

<span class="n">col</span><span class="p">(</span><span class="s2">&quot;someColumnName&quot;</span><span class="p">)</span>
<span class="n">column</span><span class="p">(</span><span class="s2">&quot;someColumnName&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;someColumnName&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="expressions">
<span id="header-n256"></span><h4>2.2.2 Expressions<a class="headerlink" href="#expressions" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Columns are expressions；</p></li>
<li><p>An expression is a set of transformations on one or more values in a records in a DataFrame；</p></li>
<li><p>通过函数创建的 expression： <code class="docutils literal notranslate"><span class="pre">expr()</span></code> ，仅仅是对 DataFrame 的 columns 的 reference</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">expr(&quot;someCol&quot;)</span></code> 等价于 <code class="docutils literal notranslate"><span class="pre">col(&quot;someCol&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">col()</span></code> 对 columns 进行 transformation 操作时，必须作用在 columns 的引用上</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expr()</span></code> 会将一个 string 解析为 transformations 和 columns references，并且能够继续传递给 transformations</p></li>
</ul>
</li>
<li><p>Columns are just expressions;</p></li>
<li><p>Columns and transformations of those columns compile to the same logical plan as parsed expression;</p></li>
</ul>
<p><strong>Column as Expression:</strong></p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// 下面的3个表达式是等价的 transformation</span>
<span class="c1">// Spark 会将上面的三个 transformation 解析为相同的逻辑树(logical tree)来表达操作的顺序；</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.expr</span>

<span class="n">expr</span><span class="o">(</span><span class="s">&quot;someCol - 5&quot;</span><span class="o">)</span>
<span class="n">col</span><span class="o">(</span><span class="s">&quot;someCol&quot;</span><span class="o">)</span> <span class="o">-</span> <span class="mi">5</span>
<span class="n">expr</span><span class="o">(</span><span class="s">&quot;someCol&quot;</span><span class="o">)</span> <span class="o">-</span> <span class="mi">5</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.expr</span>

<span class="n">expr</span><span class="o">(</span><span class="s">&quot;(((someCol + 5) * 200) - 6) &lt; otherCol&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>

<span class="n">expr</span><span class="p">(</span><span class="s2">&quot;(((someCol + 5) * 200) - 6) &lt; otherCol&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>查看 DataFrame 的 Columns:</strong></p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;json&quot;</span><span class="o">)</span>
   <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="o">)</span>
   <span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="records-rows">
<span id="header-n282"></span><h3>2.3 Records 和 Rows<a class="headerlink" href="#records-rows" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>在 Spark 中，DataFrame 中的每一个 row 都是一个 record； Spark 使用一个 <code class="docutils literal notranslate"><span class="pre">Row</span></code> 类型的对象表示一个 record; Spark 使用 column expression 来操作类型为 <code class="docutils literal notranslate"><span class="pre">Row</span></code> 的对象</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Row</span></code> 类型的对象在 Spark内部表现为<strong>字节数组(array of bytes)</strong></p></li>
</ul>
<p>查看 DataFrame 的第一行：</p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">first</span><span class="o">()</span>
</pre></div>
</div>
</div></blockquote>
<div class="section" id="rows">
<span id="header-n291"></span><h4>2.3.1 创建 Rows<a class="headerlink" href="#rows" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p>通过实例化一个 Row 对象创建；</p></li>
<li><p>通过实例化手动创建的 Row 必须与 DataFrame 的 Schema
中定义的列的内容的顺序一致，因为只有 DataFrame 有 Schema，而 Row
是没有 Schema的；</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.Row</span>
<span class="k">val</span> <span class="n">myRow</span> <span class="k">=</span> <span class="nc">Row</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>

<span class="c1">// 在 Scala 中通过索引获得 Row 中的值，但必须通过其他的帮助函数强制转换 Row 中的数据的类型才能得到正确的值的类型</span>
<span class="n">myRow</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>                      <span class="c1">// type Any</span>
<span class="n">myRow</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="c1">// String</span>
<span class="n">myRow</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>            <span class="c1">// String</span>
<span class="n">myRow</span><span class="o">.</span><span class="n">getInt</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>               <span class="c1">// Int</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>
<span class="n">myRow</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="c1"># 在 Python 中通过索引获得 Row 中的值，但不需要强制转换</span>
<span class="n">myRow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">myRow</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">myRow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="dataframe-transformations">
<span id="header-n300"></span><h3>2.4 DataFrame transformations<a class="headerlink" href="#dataframe-transformations" title="Permalink to this headline">¶</a></h3>
<dl class="simple">
<dt>DataFrame 上可以通过 <code class="docutils literal notranslate"><span class="pre">transformation</span></code> 进行的操作：</dt><dd><ul class="simple">
<li><p>增：add rows or columns</p></li>
<li><p>删：remove rows or columns</p></li>
<li><p>行转列：transform rows into column(or vice versa)</p></li>
<li><p>排序：change the order of rows based on the values in columns</p></li>
</ul>
</dd>
<dt>DataFrame transformation 方法和函数:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">select</span></code> method
-  working with “columns or expressions”</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">selectExpr</span></code> method
-  working with “expressions in string”</p></li>
<li><p>Package: <code class="docutils literal notranslate"><span class="pre">org.apache.spark.sql.functions</span></code></p></li>
</ul>
</dd>
</dl>
<div class="section" id="header-n327">
<span id="id4"></span><h4>2.4.1 创建 DataFrame<a class="headerlink" href="#header-n327" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li><p>从原始数据源创建 DataFrame；</p>
<ul class="simple">
<li><p>将创建的 DataFrame
转换为一个临时视图，使得可以在临时视图上进行SQL转换操作；</p></li>
</ul>
</li>
<li><p>手动创建一个行的集合并，将这个集合转换为 DataFrame；</p></li>
</ol>
<p><strong>从原始数据源创建 DataFrame:</strong></p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;json&quot;</span><span class="o">)</span>
   <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;dfTable&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;dfTable&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p><strong>通过 Row 的集合创建 DataFrame:</strong></p>
<blockquote>
<div><div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.Row</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types.</span><span class="o">{</span><span class="nc">StructType</span><span class="o">,</span> <span class="nc">StructField</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">}</span>

<span class="c1">// Schema</span>
<span class="k">val</span> <span class="n">myManualSchema</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StructType</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span>
   <span class="k">new</span> <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="kc">true</span><span class="o">),</span>
   <span class="k">new</span> <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="kc">true</span><span class="o">),</span>
   <span class="k">new</span> <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;COUNT&quot;</span><span class="o">,</span> <span class="nc">LongType</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="o">))</span>

<span class="c1">// Row</span>
<span class="k">val</span> <span class="n">myRows</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">Row</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">1L</span><span class="o">))</span>
<span class="c1">// RDD</span>
<span class="k">val</span> <span class="n">myRDD</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">myRows</span><span class="o">)</span>
<span class="c1">// DataFrame</span>
<span class="k">val</span> <span class="n">myDf</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="o">(</span><span class="n">myRDD</span><span class="o">,</span> <span class="n">myManualSchema</span><span class="o">)</span>

<span class="n">myDF</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">StructType</span><span class="p">,</span> <span class="n">StructField</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="n">LongType</span>

<span class="c1"># Schema</span>
<span class="n">myManualSchema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
   <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
   <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="kc">True</span><span class="p">),</span>
   <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;COUNT&quot;</span><span class="p">,</span> <span class="n">LongType</span><span class="p">(),</span> <span class="kc">False</span><span class="p">)</span>
<span class="p">])</span>

<span class="c1"># Row</span>
<span class="n">myRows</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># DataFrame</span>
<span class="n">myDf</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span><span class="n">myRows</span><span class="p">],</span> <span class="n">myManualSchema</span><span class="p">)</span>

<span class="n">myDf</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="select-selectexpr">
<span id="header-n343"></span><h4>2.4.2 select 和 selectExpr<a class="headerlink" href="#select-selectexpr" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.select()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">.selectExpr()</span></code> 与 SQL
进行查询的语句做同样的操作；</p></li>
</ul>
</div></blockquote>
<div class="section" id="select">
<span id="header-n349"></span><h5>2.4.2.1 方法：<code class="docutils literal notranslate"><span class="pre">.select()</span></code><a class="headerlink" href="#select" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">expr</span><span class="o">,</span> <span class="n">col</span><span class="o">,</span> <span class="n">column</span><span class="o">}</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>


<span class="c1">// different ways to refer to columns</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">),</span>
    <span class="n">col</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">),</span>
    <span class="n">column</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">),</span>
    <span class=" -Symbol">&#39;DEST_COUNTRY_NAME</span><span class="o">,</span>
    <span class="n">$</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">,</span>
    <span class="n">expr</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="c1">// Rename column</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">expr</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME AS destination&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">expr</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME AS destination&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">epxr</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">column</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># different ways to refer to columns</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">),</span>
    <span class="n">col</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">),</span>
    <span class="n">column</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Rename column</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME AS destination&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME AS destination&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">DEST_COUNTRY_NAME</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>

<span class="k">SELECT</span>
    <span class="n">DEST_COUNTRY_NAME</span><span class="p">,</span>
    <span class="n">ORIGIN_COUNTRY_NAME</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>


<span class="c1">-- Rename column</span>
<span class="k">SELECT</span>
    <span class="n">DEST_COUNTRY_NAME</span> <span class="k">AS</span> <span class="n">destination</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="selectexpr">
<span id="header-n353"></span><h5>2.4.2.2 方法：<code class="docutils literal notranslate"><span class="pre">.selectExpr():</span></code><a class="headerlink" href="#selectexpr" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME AS newColumnName&quot;</span><span class="o">,</span> <span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span>
    <span class="s">&quot;*&quot;</span><span class="o">,</span>
    <span class="s">&quot;(DEST_COUNTRY_NAME = ORIGIN_COUNTRY_NAME) AS withinCountry&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span>
    <span class="s">&quot;avg(count)&quot;</span><span class="o">,</span>
    <span class="s">&quot;count(distinct(DEST_COUNTRY_NAME))&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME AS newColumnName&quot;</span><span class="p">,</span> <span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
    <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="s2">&quot;(DEST_COUNTRY_NAME = ORIGIN_COUNTRY_NAME) AS withinCountry&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;avg(count)&quot;</span><span class="p">,</span> <span class="s2">&quot;count(distinct(DEST_COUNTRY_NAME))&quot;</span><span class="p">)</span> \
  <span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">DEST_COUNTRY_NAME</span> <span class="k">AS</span> <span class="n">newColumnName</span><span class="p">,</span>
    <span class="n">DEST_COUNTRY_NAME</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>

<span class="k">SELECT</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="p">(</span><span class="n">DEST_COUNTRY_NAME</span> <span class="o">=</span> <span class="n">ORIGIN_COUNTRY_NAME</span><span class="p">)</span> <span class="k">AS</span> <span class="n">withinCountry</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>

<span class="k">SELECT</span>
    <span class="k">AVG</span><span class="p">(</span><span class="k">count</span><span class="p">),</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="p">(</span><span class="n">DEST_COUNTRY_NAME</span><span class="p">))</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="spark-literals">
<span id="header-n357"></span><h4>2.4.3 Spark 字面量(Literals)<a class="headerlink" href="#spark-literals" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>A translation from a given programming language’s literal value to
one that Spark unstandstand；</p></li>
<li><p>Literals 是表达式(expression)；</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">expr</span><span class="o">,</span> <span class="n">lit</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">expr</span><span class="o">(</span><span class="s">&quot;*&quot;</span><span class="o">),</span> <span class="n">lit</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">as</span><span class="o">(</span><span class="nc">One</span><span class="o">)).</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span><span class="p">,</span> <span class="n">lit</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;One&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="mi">1</span> <span class="k">AS</span> <span class="n">One</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="columns-columns">
<span id="header-n367"></span><h4>2.4.4 增加 Columns、 重命名 Columns<a class="headerlink" href="#columns-columns" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.withColumn()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.withColumnRenamed()</span></code></p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.expr</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;numberOne&quot;</span><span class="o">,</span> <span class="n">lit</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;withinCountry&quot;</span><span class="o">,</span> <span class="n">expr</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME = ORIGIN_COUNTRY_NAME&quot;</span><span class="o">))</span>
  <span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="c1">// rename column</span>
<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;destination&quot;</span><span class="o">,</span> <span class="n">expr</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="s">&quot;dest&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;numberOne&quot;</span><span class="p">,</span> <span class="n">lit</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;withinCountry&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME = ORIGIN_COUNTRY_NAME&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># rename column</span>
<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;dest&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="reserved-characters-and-keywords">
<span id="header-n376"></span><h4>2.4.5 转义字符和关键字(reserved characters and keywords)<a class="headerlink" href="#reserved-characters-and-keywords" title="Permalink to this headline">¶</a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.expr</span>

<span class="c1">// rename column &quot;ORIGIN_COUNTRY_NAME&quot;</span>
<span class="k">val</span> <span class="n">dfWithLongColName</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span>
    <span class="s">&quot;This Long Column-Name&quot;</span><span class="o">,</span>
    <span class="n">expr</span><span class="o">(</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">))</span>


<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span>
    <span class="s">&quot;`This Long Column-Name`&quot;</span><span class="o">,</span>
    <span class="s">&quot;`This Long Column-Name` as `new col`&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">expr</span><span class="o">(</span><span class="s">&quot;`This Long Column-Name`&quot;</span><span class="o">))</span>
    <span class="o">.</span><span class="n">columns</span>

<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;This Long Column-Name&quot;</span><span class="o">))</span>
    <span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>

<span class="c1"># rename column &quot;ORIGIN_COUNTRY_NAME&quot;</span>
<span class="n">dfWithLongColName</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
    <span class="s2">&quot;This Long Column-Name&quot;</span><span class="p">,</span>
    <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">))</span>

<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
    <span class="s2">&quot;`This Long Column-Name`&quot;</span><span class="p">,</span>
    <span class="s2">&quot;`This Long Column-Name` as `new col`&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;`This Long Column-Name`&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">columns</span>

<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;This Long Column-Name&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="o">`</span><span class="n">This</span> <span class="n">Long</span> <span class="k">Column</span><span class="o">-</span><span class="n">Name</span><span class="o">`</span><span class="p">,</span>
    <span class="o">`</span><span class="n">This</span> <span class="n">Long</span> <span class="k">Column</span><span class="o">-</span><span class="n">Name</span><span class="o">`</span> <span class="k">AS</span> <span class="o">`</span><span class="k">new</span> <span class="n">col</span><span class="o">`</span>
<span class="k">FROM</span> <span class="n">dfTableLong</span>
<span class="k">LIMIT</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="case-sensitivity">
<span id="header-n380"></span><h4>2.4.6 Case Sensitivity<a class="headerlink" href="#case-sensitivity" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>Spark 默认是大小写不敏感的，即不区分大小写；</p>
</div></blockquote>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">set</span> <span class="n">spark</span><span class="p">.</span><span class="k">sql</span><span class="p">.</span><span class="n">caseSensitive</span> <span class="k">true</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n384">
<span id="id5"></span><h4>2.4.7 删除 Columns<a class="headerlink" href="#header-n384" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.select()</span></code>；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.drop()</span></code>；</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">columns</span>

<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">drop</span><span class="o">(</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">columns</span>

<span class="n">dfWithLongColName</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="columns-cast">
<span id="header-n394"></span><h4>2.4.8 改变 Columns 的类型(cast)<a class="headerlink" href="#columns-cast" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.cast()</span></code></p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;count2&quot;</span><span class="o">,</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">).</span><span class="n">cast</span><span class="o">(</span><span class="s">&quot;long&quot;</span><span class="o">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;count2&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;long&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="k">CAST</span><span class="p">(</span><span class="k">count</span> <span class="k">as</span> <span class="n">long</span><span class="p">)</span> <span class="k">AS</span> <span class="n">count2</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n403">
<span id="id6"></span><h4>2.4.9 筛选行<a class="headerlink" href="#header-n403" title="Permalink to this headline">¶</a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;count&quot;</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span>
  <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">)</span> <span class="o">=!=</span> <span class="s">&quot;Croatia&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;count&quot;</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">)</span> <span class="o">=!=</span> <span class="s2">&quot;Croatia&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">WHERE</span> <span class="k">count</span> <span class="o">&lt;</span> <span class="mi">2</span>
<span class="k">LIMIT</span> <span class="mi">2</span>

<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">WHERE</span> <span class="k">count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">AND</span> <span class="n">ORIGIN_COUNTRY_NAME</span> <span class="o">!=</span> <span class="s1">&#39;Croatia&#39;</span>
<span class="k">LIMIT</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="unique-distinct">
<span id="header-n408"></span><h4>2.4.10 获取不重复(Unique/Distinct)的行<a class="headerlink" href="#unique-distinct" title="Permalink to this headline">¶</a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="o">,</span> <span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">distinct</span><span class="o">()</span>
  <span class="o">.</span><span class="n">count</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">distinct</span><span class="p">()</span> \
  <span class="o">.</span><span class="n">count</span><span class="p">()</span> \
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span><span class="p">(</span><span class="n">ORIGIN_COUNTRY_NAME</span><span class="p">,</span> <span class="n">DEST_COUNTRY_NAME</span><span class="p">))</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n412">
<span id="id7"></span><h4>2.4.11 随机抽样<a class="headerlink" href="#header-n412" title="Permalink to this headline">¶</a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">seed</span> <span class="k">=</span> <span class="mi">5</span>
<span class="k">val</span> <span class="n">withReplacement</span> <span class="k">=</span> <span class="kc">false</span>
<span class="k">val</span> <span class="n">fraction</span> <span class="k">=</span> <span class="mf">0.5</span>
<span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="o">(</span><span class="n">withReplacement</span><span class="o">,</span> <span class="n">fraction</span><span class="o">,</span> <span class="n">seed</span><span class="o">)</span>
  <span class="o">.</span><span class="n">count</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">withReplacement</span> <span class="o">=</span> <span class="n">false</span>
<span class="n">fraction</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n415">
<span id="id8"></span><h4>2.4.12 随机分割<a class="headerlink" href="#header-n415" title="Permalink to this headline">¶</a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">seed</span> <span class="k">=</span> <span class="mi">5</span>
<span class="k">val</span> <span class="n">dataFrames</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">randomSplit</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span><span class="mf">0.25</span><span class="o">,</span> <span class="mf">0.75</span><span class="o">),</span> <span class="n">seed</span><span class="o">)</span>
<span class="n">dataFrames</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">count</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">dataFrames</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">count</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">dataFrames</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">],</span> <span class="n">seed</span><span class="p">)</span>
<span class="n">dataFrames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">dataFrames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="concatenating-appending">
<span id="header-n418"></span><h4>2.4.13 拼接(Concatenating)和追加(Appending)行<a class="headerlink" href="#concatenating-appending" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>由于 DataFrame 是不可变的(immutable)，因此不能将数据 append 到
DataFrame 的后面，append 会改变 DataFrame；</p></li>
<li><p>对于两个需要 Union 的 DataFrame，需要具有相同的 Schema
和相同数量的 Column，否则就会失败；</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.Row</span>

<span class="k">val</span> <span class="n">schema</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span>
<span class="k">val</span> <span class="n">newRows</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="nc">Row</span><span class="o">(</span><span class="s">&quot;New Country&quot;</span><span class="o">,</span> <span class="s">&quot;Other Country&quot;</span><span class="o">,</span> <span class="mi">5L</span><span class="o">),</span>
    <span class="nc">Row</span><span class="o">(</span><span class="s">&quot;New Country 2&quot;</span><span class="o">,</span> <span class="s">&quot;Other Country 3&quot;</span><span class="o">,</span> <span class="mi">1L</span><span class="o">)</span>
<span class="o">)</span>
<span class="k">val</span> <span class="n">parallelizedRows</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">newRows</span><span class="o">)</span>
<span class="k">val</span> <span class="n">newDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="o">(</span><span class="n">parallelizedRows</span><span class="o">,</span> <span class="n">schema</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">union</span><span class="o">(</span><span class="n">newDF</span><span class="o">)</span>
  <span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;count = 1&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;ORIGIN_COUNTRY_NAME&quot;</span> <span class="o">=!=</span> <span class="s">&quot;United States&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>

<span class="n">schema</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">schema</span>
<span class="n">newRow</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Row</span><span class="p">(</span><span class="s2">&quot;New Country&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Country&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="n">L</span><span class="p">),</span>
    <span class="n">Row</span><span class="p">(</span><span class="s2">&quot;New Country 2&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Country 3&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="n">L</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">parallelizedRow</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">newRows</span><span class="p">)</span>
<span class="n">newDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">parallelizedRows</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">newDF</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;count = 1&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ORIGIN_COUNTRY_NAME&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;United States&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n428">
<span id="id9"></span><h4>2.4.14 行排序<a class="headerlink" href="#header-n428" title="Permalink to this headline">¶</a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">desc</span><span class="o">,</span> <span class="n">asc</span><span class="o">}</span>

<span class="n">df</span><span class="o">.</span><span class="n">sort</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">,</span> <span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">),</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">)).</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="n">expr</span><span class="o">(</span><span class="s">&quot;count desc&quot;</span><span class="o">),</span> <span class="n">expr</span><span class="o">(</span><span class="s">&quot;DESC_COUNTRY_NAME asc&quot;</span><span class="o">)).</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="n">desc</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">),</span> <span class="n">asc</span><span class="o">(</span><span class="s">&quot;DESC_COUNTRY_NAME&quot;</span><span class="o">)).</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span>
    <span class="n">asc_nulls_first</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">),</span>
    <span class="n">desc_nulls_first</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">),</span>
    <span class="n">asc_nulls_last</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">),</span>
    <span class="n">desc_nulls_last</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span>
<span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">asc</span>
<span class="n">df</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;count desc&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;DESC_COUNTRY_NAME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">DEST_COUNTRY_NAME</span> <span class="k">ASC</span>
<span class="k">LIMIT</span> <span class="mi">2</span>
</pre></div>
</div>
<p>为了优化的目的，建议对每个分区的数据在进行 transformations
之前进行排序：</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;json&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/flight-data/json&quot;</span><span class="o">*-</span><span class="n">summary</span><span class="o">.</span><span class="n">json</span><span class="o">)</span>
    <span class="o">.</span><span class="n">sortWithPartitions</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/data/flight-data/json&quot;</span><span class="o">*-</span><span class="n">summary</span><span class="o">.</span><span class="n">json</span><span class="p">)</span>
    <span class="o">.</span><span class="n">sortWithPartitions</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="limit">
<span id="header-n436"></span><h4>2.4.15 Limit<a class="headerlink" href="#limit" title="Permalink to this headline">¶</a></h4>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">6</span>
</pre></div>
</div>
</div>
<div class="section" id="repartiton-and-coalesce">
<span id="header-n440"></span><h4>2.4.16 Repartiton(重新分区) and Coalesce(分区聚合)<a class="headerlink" href="#repartiton-and-coalesce" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>为了优化的目的，可以根据一些常用来进行筛选(filter)操作的 column
进行进行分区；</p></li>
<li><p>Repartition
会对数据进行全部洗牌，来对数据进行重新分区(未来的分区数 &gt;=
当前分区数)；</p></li>
<li><p>Coalesce 不会对数据进行全部洗牌操作，会对数据分区进行聚合；</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.col</span>
<span class="n">df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span>

<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="n">col</span><span class="o">(</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">)).</span><span class="n">coalesce</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>
<span class="n">df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;DEST_COUNTRY_NAME&quot;</span><span class="p">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="n">DEST_COUNTRY_NAME</span><span class="p">))</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="collecting-rows-to-the-driver">
<span id="header-n452"></span><h4>2.4.17 Collecting Rows to the Driver<a class="headerlink" href="#collecting-rows-to-the-driver" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>Spark 在驱动程序(driver)上维持集群的状态；</p></li>
<li><p>方法：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">.collect()</span></code></p>
<ul>
<li><p>get all data from the entire DataFrame</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">.take(N)</span></code></p>
<ul>
<li><p>select the first N rows</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">.show(N,</span> <span class="pre">true)</span></code></p>
<ul>
<li><p>print out a number of rows nicely</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">.toLocalIterator()</span></code></p>
<ul>
<li><p>collect partitions to the dirver as an iterator</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">collectDF</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>

<span class="n">collectDF</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="c1">// take works with on Integer count</span>

<span class="n">collectDF</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>  <span class="c1">// print out nicely</span>
<span class="n">collectDf</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>

<span class="n">collectDF</span><span class="o">.</span><span class="n">collect</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">collectDF</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">collectDF</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">//</span> <span class="n">take</span> <span class="n">works</span> <span class="k">with</span> <span class="n">on</span> <span class="n">Integer</span> <span class="n">count</span>

<span class="n">collectDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="o">//</span> <span class="nb">print</span> <span class="n">out</span> <span class="n">nicely</span>
<span class="n">collectDf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>

<span class="n">collectDF</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="converting-spark-types">
<span id="header-n482"></span><h4>2.4.18 Converting Spark Types<a class="headerlink" href="#converting-spark-types" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>Convert native types to Spark types；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">org.apache.spark.sql.functions.lit</span></code></p></li>
</ul>
</div></blockquote>
<p><strong>读取数据，创建 DataFrame:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;csv&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;header&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;inferSchema&quot;</span><span class="o">,</span> <span class="s">&quot;ture&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/retail-data/by-day/2010-12-01.csv&quot;</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="o">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;dfTable&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;csv&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;inferSchema&quot;</span><span class="p">,</span> <span class="s2">&quot;ture&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/data/retail-data/by-day/2010-12-01.csv&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;dfTable&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>转换为 Spark 类型数据：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.lit</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">lit</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">lit</span><span class="o">(</span><span class="s">&quot;five&quot;</span><span class="o">),</span> <span class="n">lit</span><span class="o">(</span><span class="mf">5.0</span><span class="o">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">lit</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="s2">&quot;five&quot;</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="mf">5.0</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="mi">5</span><span class="p">,</span> <span class="ss">&quot;five&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="boolean">
<span id="header-n497"></span><h4>2.4.19 Boolean<a class="headerlink" href="#boolean" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>Spark Boolean 语句:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">and</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">or</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">true</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">false</span></code></p></li>
</ul>
</li>
<li><p>Spark 中的相等与不等:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">===</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">.equalTo()</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">=!=</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">not()</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<p><strong>等于，不等于：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.col</span>

<span class="c1">// equalTo(), ===</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">).</span><span class="n">equalTo</span><span class="o">(</span><span class="mi">536365</span><span class="o">))</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;Description&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">)</span> <span class="o">===</span> <span class="mi">536365</span><span class="o">)</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;Description&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>


<span class="c1">// not(), =!=</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">).</span><span class="n">not</span><span class="o">(</span><span class="mi">536365</span><span class="o">))</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;Description&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">)</span> <span class="o">=!=</span> <span class="mi">536365</span><span class="o">)</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;Description&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>


<span class="c1">// specify the predicate as an expression in a string, =/&lt;&gt;</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;InvoiceNo = 536365&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;InvoiceNo &lt;&gt; 536365&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>

<span class="c1"># Spark: equalTo(), ===</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">equalTo</span><span class="p">(</span><span class="mi">536365</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span> <span class="o">===</span> <span class="mi">536365</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>


<span class="c1"># Spark: not(), =!=</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span><span class="o">.</span><span class="ow">not</span><span class="p">(</span><span class="mi">536365</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span> <span class="o">=!=</span> <span class="mi">536365</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>

<span class="c1"># python</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">536365</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Description&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>

<span class="c1"># specify the predicate as an expression in a string, =/&lt;&gt;</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;InvoiceNo = 536365&quot;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;InvoiceNo &lt;&gt; 536365&quot;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">false</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>and, or:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">priceFilter</span> <span class="k">=</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;UnitPrice&quot;</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">600</span>
<span class="k">val</span> <span class="n">descripFilter</span> <span class="k">=</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">).</span><span class="n">contains</span><span class="o">(</span><span class="s">&quot;POSTAGE&quot;</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">).</span><span class="n">isin</span><span class="o">(</span><span class="s">&quot;DOT&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="n">priceFilter</span><span class="o">.</span><span class="n">or</span><span class="o">(</span><span class="n">descripFilter</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">inst</span>

<span class="n">priceFilter</span> <span class="o">=</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;UnitPrice&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">600</span>
<span class="n">descripFilter</span> <span class="o">=</span> <span class="n">instr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span> <span class="s2">&quot;POSTAGE&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="n">df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">StockCode</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="s2">&quot;DOT&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">priceFilter</span> <span class="o">|</span> <span class="n">descripFilter</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span>
    <span class="n">dfTable</span>
<span class="k">WHERE</span>
    <span class="n">StockCode</span> <span class="k">IN</span> <span class="p">(</span><span class="ss">&quot;DOT&quot;</span><span class="p">)</span> <span class="k">AND</span>
    <span class="p">(</span><span class="n">UnitPrice</span> <span class="o">&gt;</span> <span class="mi">600</span> <span class="k">OR</span> <span class="n">instr</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="ss">&quot;POSTAGE&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>使用 Boolean column 筛选 DataFrame：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="nc">DOTCodeFilter</span> <span class="k">=</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="s">&quot;DOT&quot;</span>
<span class="k">val</span> <span class="n">priceFilter</span> <span class="k">=</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;UnitPrice&quot;</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">600</span>
<span class="k">val</span> <span class="n">descripFilter</span> <span class="k">=</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">).</span><span class="n">contains</span><span class="o">(</span><span class="s">&quot;POSTAGE&quot;</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;isExpensive&quot;</span><span class="o">,</span> <span class="nc">DOTCodeFilter</span><span class="o">.</span><span class="n">and</span><span class="o">(</span><span class="n">priceFilter</span><span class="o">.</span><span class="n">or</span><span class="o">(</span><span class="n">descripFilter</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;isExpensive&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;unitPrice&quot;</span><span class="o">,</span> <span class="s">&quot;isExpensive&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">instr</span>

<span class="n">DOTCodeFilter</span> <span class="o">=</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;DOT&quot;</span>
<span class="n">priceFilter</span> <span class="o">=</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;UnitPrice&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">600</span>
<span class="n">descripFilter</span> <span class="o">=</span> <span class="n">instr</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="s2">&quot;POSTAGE&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;isExpensive&quot;</span><span class="p">,</span> <span class="n">DOTCodeFilter</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">priceFilter</span> <span class="o">|</span> <span class="n">descripFilter</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;isExpensive&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;unitPrice&quot;</span><span class="p">,</span> <span class="s2">&quot;isExpensive&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">UnitPrice</span>
    <span class="p">,(</span>
        <span class="n">StockCode</span> <span class="o">=</span> <span class="ss">&quot;DOT&quot;</span> <span class="k">AND</span>
        <span class="p">(</span><span class="n">UnitPrice</span> <span class="o">&gt;</span> <span class="mi">600</span> <span class="k">OR</span> <span class="n">instr</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="ss">&quot;POSTAGE&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span> <span class="k">AS</span> <span class="n">isExpensive</span>
<span class="k">FROM</span>
    <span class="n">dfTable</span>
<span class="k">WHERE</span>
    <span class="p">(</span>
        <span class="n">StockCode</span> <span class="o">=</span> <span class="ss">&quot;DOT&quot;</span> <span class="k">AND</span>
        <span class="p">(</span><span class="n">UnitPrice</span> <span class="o">&gt;</span> <span class="mi">600</span> <span class="k">OR</span> <span class="n">instr</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="ss">&quot;POSTAGE&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
<p><strong>其他：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">expr</span><span class="o">,</span> <span class="n">not</span><span class="o">,</span> <span class="n">col</span><span class="o">}</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;isExpensive&quot;</span><span class="o">,</span> <span class="n">not</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;UnitPrice&quot;</span><span class="o">).</span><span class="n">len</span><span class="o">(</span><span class="mi">250</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">&quot;isExpensive&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">,</span> <span class="s">&quot;UnitPrice&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;isExpensive&quot;</span><span class="o">,</span> <span class="n">expr</span><span class="o">(</span><span class="s">&quot;NOT UnitPrice &lt;= 250&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="s">&quot;isExpensive&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">,</span> <span class="s">&quot;UnitPrice&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;isExpensive&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;NOT UnitPrice &lt;= 250&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;isExpensive&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> <span class="s2">&quot;UnitPrice&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="number">
<span id="header-n539"></span><h4>2.4.20 Number<a class="headerlink" href="#number" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>functions:</p>
<ul>
<li><p>select(pow())</p></li>
<li><p>selectExpr(“POWER()”)</p></li>
</ul>
</li>
</ul>
</div></blockquote>
<p><strong>Function: ``pow``:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">expr</span><span class="o">,</span> <span class="n">pow</span><span class="o">}</span>

<span class="k">val</span> <span class="n">fabricateQuantity</span> <span class="k">=</span> <span class="n">pow</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">)</span> <span class="o">*</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;UnitPrice&quot;</span><span class="o">),</span> <span class="mi">2</span><span class="o">)</span> <span class="o">+</span> <span class="mi">5</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">expr</span><span class="o">(</span><span class="s">&quot;CustomerId&quot;</span><span class="o">),</span> <span class="n">fabricateQuantity</span><span class="o">.</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;realQuantity&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span>
    <span class="s">&quot;CustomerId&quot;</span><span class="o">,</span>
    <span class="s">&quot;(POWER((Quantity * UnitPrice), 2.0) + 5) as realQuantity&quot;</span>
<span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">expr</span><span class="p">,</span> <span class="nb">pow</span>

<span class="n">fabricateQuantity</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;UnitPrice&quot;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">expr</span><span class="p">(</span><span class="s2">&quot;CustomerId&quot;</span><span class="p">),</span> <span class="n">fabricateQuantity</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;realQuantity&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
    <span class="s2">&quot;CustomerId&quot;</span><span class="p">,</span>
    <span class="s2">&quot;POWER((Quantity * UnitPrice), 2.0) + 5 as realQuantity&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- SQL</span>
<span class="k">SELECT</span>
    <span class="n">customerId</span><span class="p">,</span>
    <span class="p">(</span><span class="n">POWER</span><span class="p">((</span><span class="n">Quantity</span> <span class="o">*</span> <span class="n">UnitPrice</span><span class="p">),</span> <span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">realQuantity</span>
<span class="k">FROM</span>
    <span class="n">dfTable</span>
</pre></div>
</div>
</div>
<div class="section" id="string">
<span id="header-n555"></span><h4>2.4.21 String<a class="headerlink" href="#string" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>字符串函数</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">initcap</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lower</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">upper</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ltrim</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rtrim</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trim</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lpad</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rpad</span></code></p></li>
</ul>
</li>
<li><p>正则表达式(Regular Expressions)</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">initcap</span><span class="o">,</span> <span class="n">lower</span><span class="o">,</span> <span class="n">upper</span><span class="o">,</span> <span class="n">lit</span><span class="o">,</span> <span class="n">col</span><span class="o">,</span> <span class="n">ltrim</span><span class="o">,</span> <span class="n">rtrim</span><span class="o">,</span> <span class="n">trim</span><span class="o">,</span> <span class="n">lpad</span><span class="o">,</span> <span class="n">rpad</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">initcap</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">),</span> <span class="n">lower</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">)),</span> <span class="n">upper</span><span class="o">(</span><span class="n">lower</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">))))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">ltrim</span><span class="o">(</span><span class="n">lit</span><span class="o">(</span><span class="s">&quot;    HELLO    &quot;</span><span class="o">)).</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;ltrim&quot;</span><span class="o">),</span>
    <span class="n">rtrim</span><span class="o">(</span><span class="n">lit</span><span class="o">(</span><span class="s">&quot;    HELLO    &quot;</span><span class="o">)).</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;rtrim&quot;</span><span class="o">),</span>
    <span class="n">trim</span><span class="o">(</span><span class="n">lit</span><span class="o">(</span><span class="s">&quot;    HELLO    &quot;</span><span class="o">)).</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;trim&quot;</span><span class="o">),</span>
    <span class="n">lpad</span><span class="o">(</span><span class="n">lit</span><span class="o">(</span><span class="s">&quot;HELLO&quot;</span><span class="o">),</span> <span class="mi">3</span><span class="o">,</span> <span class="s">&quot; &quot;</span><span class="o">).</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;lp&quot;</span><span class="o">),</span>
    <span class="n">rpad</span><span class="o">(</span><span class="n">lit</span><span class="o">(</span><span class="s">&quot;HELLO&quot;</span><span class="o">),</span> <span class="mi">3</span><span class="o">,</span> <span class="s">&quot; &quot;</span><span class="o">).</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;rp&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">initcap</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lit</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">ltrim</span><span class="p">,</span> <span class="n">rtrim</span><span class="p">,</span> <span class="n">trim</span><span class="p">,</span> <span class="n">lpad</span><span class="p">,</span> <span class="n">rpad</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">initcap</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">)))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="n">lower</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">)),</span> <span class="n">upper</span><span class="p">(</span><span class="n">lower</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">))))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">ltrim</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;    HELLO    &quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ltrim&quot;</span><span class="p">),</span>
    <span class="n">rtrim</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;    HELLO    &quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;rtrim&quot;</span><span class="p">),</span>
    <span class="n">trim</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;    HELLO    &quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;trim&quot;</span><span class="p">),</span>
    <span class="n">lpad</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;HELLO&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;lp&quot;</span><span class="p">),</span>
    <span class="n">rpad</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;HELLO&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;rp&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span> <span class="n">initcap</span><span class="p">(</span><span class="n">Description</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>


<span class="k">SELECT</span>
    <span class="n">Description</span><span class="p">,</span>
    <span class="k">lower</span><span class="p">(</span><span class="n">Description</span><span class="p">),</span>
    <span class="k">upper</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">Description</span><span class="p">))</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">LIMIT</span> <span class="mi">2</span>



<span class="k">SELECT</span>
    <span class="n">ltrim</span><span class="p">(</span><span class="s1">&#39;    HELLLOOO  &#39;</span><span class="p">),</span>
    <span class="n">rtrim</span><span class="p">(</span><span class="s1">&#39;    HELLLOOO  &#39;</span><span class="p">),</span>
    <span class="k">trim</span><span class="p">(</span><span class="s1">&#39;    HELLLOOO  &#39;</span><span class="p">),</span>
    <span class="n">lpad</span><span class="p">(</span><span class="s1">&#39;HELLLOOO  &#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span>
    <span class="n">rpad</span><span class="p">(</span><span class="s1">&#39;HELLLOOO  &#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
</div>
<div class="section" id="date-and-timestamp">
<span id="header-n585"></span><h4>2.4.22 Date and Timestamp<a class="headerlink" href="#date-and-timestamp" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="null-data">
<span id="header-n587"></span><h4>2.4.23 Null Data<a class="headerlink" href="#null-data" title="Permalink to this headline">¶</a></h4>
<div class="section" id="coalesce">
<span id="header-n588"></span><h5>2.4.23.1 Coalesce<a class="headerlink" href="#coalesce" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">replace</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="o">))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">na</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;UNKNOWN&quot;</span><span class="p">],</span> <span class="s2">&quot;Description&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ifnull-nullif-nvl-nvl2">
<span id="header-n591"></span><h5>2.4.23.2 ifnull, nullif, nvl, nvl2<a class="headerlink" href="#ifnull-nullif-nvl-nvl2" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="drop">
<span id="header-n594"></span><h5>2.4.23.3 drop<a class="headerlink" href="#drop" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="fill">
<span id="header-n597"></span><h5>2.4.23.4 fill<a class="headerlink" href="#fill" title="Permalink to this headline">¶</a></h5>
</div>
<div class="section" id="replace">
<span id="header-n599"></span><h5>2.4.23.5 replace<a class="headerlink" href="#replace" title="Permalink to this headline">¶</a></h5>
</div>
</div>
<div class="section" id="ordering">
<span id="header-n603"></span><h4>2.4.24 Ordering<a class="headerlink" href="#ordering" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>asc<em>null</em>first()</p></li>
<li><p>asc<em>null</em>last()</p></li>
<li><p>desc<em>null</em>first()</p></li>
<li><p>desc<em>null</em>last()</p></li>
</ul>
</div>
<div class="section" id="complex-types">
<span id="header-n613"></span><h4>2.4.25 复杂类型 Complex Types<a class="headerlink" href="#complex-types" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>Struct(s)</p></li>
<li><p>Array(s)</p></li>
<li><p>split</p></li>
<li><p>Array Length</p></li>
<li><p>array_contains</p></li>
<li><p>explode</p></li>
<li><p>Maps</p></li>
</ul>
</div></blockquote>
<div class="section" id="struct">
<span id="header-n630"></span><h5>2.4.25.1 Struct<a class="headerlink" href="#struct" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ul class="simple">
<li><p>Struct: DataFrames in DataFrame</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;(Description, InvoiceNo) as complex&quot;</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;struct(Description, InvoiceNo) as complex&quot;</span><span class="o">,</span> <span class="s">&quot;*&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">complexDF</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">struct</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">,</span> <span class="s">&quot;InvoiceNo&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;complex&quot;</span><span class="o">))</span>
<span class="n">complexDF</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;complexDF&quot;</span><span class="o">)</span>

<span class="n">complexDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;complex.Description&quot;</span><span class="o">)</span>
<span class="n">complexDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;complex&quot;</span><span class="o">).</span><span class="n">getField</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">))</span>
<span class="n">complexDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;complex.*&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;(Description, InvoiceNo) as complex&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;struct(Description, InvoiceNo) as complex&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">struct</span>
<span class="n">complexDF</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">struct</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> <span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;complex&quot;</span><span class="p">))</span>
<span class="n">complexDF</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;complexDF&quot;</span><span class="p">)</span>

<span class="n">complexDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;complex.Description&quot;</span><span class="p">)</span>
<span class="n">complexDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;complex&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getField</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">))</span>
<span class="n">complexDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;complex.*&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="n">complex</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span>
    <span class="n">complexDF</span>
</pre></div>
</div>
</div>
<div class="section" id="array">
<span id="header-n638"></span><h5>2.4.25.2 Array<a class="headerlink" href="#array" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>split</p></li>
<li><p>Array Length</p></li>
<li><p>array_contains</p></li>
<li><p>explode</p></li>
</ul>
<p><strong>split():</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.split</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">split</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">),</span> <span class="s">&quot; &quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;array_col&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;array_col[0]&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">split</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;array_col&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;array_col[0]&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- sql</span>
<span class="k">SELECT</span>
    <span class="n">split</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">FROM</span>
    <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>Array Length: size()</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.size</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">size</span><span class="o">(</span><span class="n">split</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">),</span> <span class="s">&quot; &quot;</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">size</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="p">)))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>array_contains():</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.array_contains</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">array_contains</span><span class="o">(</span><span class="n">split</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">),</span> <span class="s">&quot; &quot;</span><span class="o">),</span> <span class="s">&quot;WHITE&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">array_contains</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">array_contains</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="s2">&quot;WHITE&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">array_contains</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="ss">&quot;WHITE&quot;</span><span class="p">)</span>
<span class="k">FROM</span>
    <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>explode():</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">split</span><span class="o">,</span> <span class="n">explode</span><span class="o">}</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;splitted&quot;</span><span class="o">,</span> <span class="n">split</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">),</span> <span class="s">&quot; &quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;exploded&quot;</span><span class="o">,</span> <span class="n">explode</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="n">splitted</span><span class="o">)))</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">,</span> <span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;exploded&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">split</span><span class="p">,</span> <span class="n">explode</span>

<span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;splitted&quot;</span><span class="p">,</span> <span class="n">split</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="s2">&quot; &quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;exploded&quot;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">splitted</span><span class="p">)))</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> <span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;exploded&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">Description</span><span class="p">,</span>
    <span class="n">InvoiceNO</span><span class="p">,</span>
    <span class="n">exploded</span>
<span class="k">FROM</span>
    <span class="p">(</span>
        <span class="k">SELECT</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">split</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="ss">&quot; &quot;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">splitted</span>
        <span class="k">FROM</span> <span class="n">dfTable</span>
    <span class="p">)</span>
<span class="k">LATERAL</span> <span class="k">VIEW</span> <span class="n">explode</span><span class="p">(</span><span class="n">splitted</span><span class="p">)</span> <span class="k">AS</span> <span class="n">exploded</span>
</pre></div>
</div>
</div>
<div class="section" id="maps">
<span id="header-n666"></span><h5>2.4.25.3 Maps<a class="headerlink" href="#maps" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.map</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">map</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">),</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">)).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;complex_map&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;complex_map[&#39;WHITE_METAL_LANTERN&#39;]&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">map</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">),</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">)).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;complex_map&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;explode(complex_map)&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">map</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;complex_map&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;complex_map[&#39;WHITE_METAL_LANTERN&#39;]&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;complex_map&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;explode(complex_map)&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">map</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="n">InvoiceNo</span><span class="p">)</span> <span class="k">AS</span> <span class="n">complex_map</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">WHERE</span> <span class="n">Description</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="json">
<span id="header-n671"></span><h4>2.4.26 Json<a class="headerlink" href="#json" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Spark 有一些对 JSON 数据的独特的操作</p>
<ul>
<li><p>可以直接操作 JSON 字符串</p></li>
<li><p>可以从 JSON 对象中解析或提取数据为 DataFrame</p></li>
<li><p>把 StructType 转换为 JSON 字符串</p></li>
</ul>
</li>
</ul>
<p><strong>可以直接操作 JSON 字符串：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>

<span class="k">val</span> <span class="n">jsonDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    &#39;{</span>
<span class="s">        &quot;myJSONKey&quot;: {</span>
<span class="s">            &quot;myJSONValue&quot;: {</span>
<span class="s">                1, 2, 3</span>
<span class="s">            }</span>
<span class="s">        }</span>
<span class="s">    }&#39; as jsonString</span>
<span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>

<span class="n">jsonDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &#39;{</span>
<span class="s2">        &quot;myJSONKey&quot;: {</span>
<span class="s2">            &quot;myJSONValue&quot;: {</span>
<span class="s2">                1, 2, 3</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">    }&#39; as jsonString</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>可以从 JSON 对象中解析或提取数据为 DataFrame：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">get_json_object</span><span class="o">,</span> <span class="n">json_tuple</span><span class="o">}</span>

<span class="n">jsonDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">get_json_object</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;jsonString&quot;</span><span class="o">),</span> <span class="s">&quot;$.myJSONKey.myJSONValue[1]&quot;</span><span class="o">)</span> <span class="n">as</span> <span class="s">&quot;column&quot;</span><span class="o">,</span>
    <span class="n">json_tuple</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;jsonString&quot;</span><span class="o">),</span> <span class="s">&quot;myJSONKey&quot;</span><span class="o">))</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">get_json_object</span><span class="p">,</span> <span class="n">json_tuple</span>

<span class="n">jsonDF</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">get_json_object</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;jsonString&quot;</span><span class="p">),</span> <span class="s2">&quot;$.myJSONKey.myJSONValue[1]&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="s2">&quot;column&quot;</span><span class="p">,</span>
    <span class="n">json_tuple</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;jsonString&quot;</span><span class="p">),</span> <span class="s2">&quot;myJSONKey&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>把 StructType 转换为 JSON 字符串：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.to_json</span>
<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;(InvoiceNo, Description) as myStruct&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">to_json</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;myStruct&quot;</span><span class="o">)))</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">to_json</span>
<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;(InvoiceNo, Description) as myStruct&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;myStruct&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.from_json</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>

<span class="k">val</span> <span class="n">parseSchema</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SturctType</span><span class="o">(</span><span class="nc">Array</span><span class="o">(</span>
    <span class="k">new</span> <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="kc">true</span><span class="o">),</span>
    <span class="k">new</span> <span class="nc">StructField</span><span class="o">(</span><span class="s">&quot;Description&quot;</span><span class="o">,</span> <span class="nc">StringType</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
    <span class="o">)</span>
<span class="o">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;(InvoiceNo, Description) as myStruct&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">to_json</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;myStruct&quot;</span><span class="o">)).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;newJSON&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">from_json</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;newJSON&quot;</span><span class="o">),</span> <span class="n">parseShcema</span><span class="o">),</span> <span class="n">col</span><span class="o">(</span><span class="s">&quot;newJSON&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">from_json</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">parseSchema</span> <span class="o">=</span> <span class="n">SturctType</span><span class="p">((</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;(InvoiceNo, Description) as myStruct&quot;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">to_json</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;myStruct&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;newJSON&quot;</span><span class="p">))</span>
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">from_json</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;newJSON&quot;</span><span class="p">),</span> <span class="n">parseShcema</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">&quot;newJSON&quot;</span><span class="p">))</span>
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="user-defined-functions-udf">
<span id="header-n696"></span><h4>2.4.27 用户自定义函数 User-Defined Functions(UDF)<a class="headerlink" href="#user-defined-functions-udf" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>User-Defined Functions (UDF) make it possible for you to write
your own custom transformations using Python or Scala and even use
external libraries.</p></li>
</ul>
</div></blockquote>
<p>示例：</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>

<span class="c1">// DataFrame</span>
<span class="k">val</span> <span class="n">udfExampleDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="o">(</span><span class="mi">5</span><span class="o">).</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;num&quot;</span><span class="o">)</span>

<span class="c1">// UDF power of 3</span>
<span class="k">def</span> <span class="n">power3</span><span class="o">(</span><span class="n">number</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">number</span> <span class="o">*</span> <span class="n">number</span> <span class="o">*</span> <span class="n">number</span>
<span class="o">}</span>

<span class="n">power3</span><span class="o">(</span><span class="mf">2.0</span><span class="o">)</span>

<span class="c1">// Register the UDF to make it available as a DataFrame Function</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.udf</span>
<span class="k">val</span> <span class="n">power3udf</span> <span class="k">=</span> <span class="n">udf</span><span class="o">(</span><span class="n">power3</span><span class="o">(</span><span class="k">_:</span><span class="kt">Double</span><span class="o">)</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span>

<span class="c1">// Use UDF as DataFrame function</span>
<span class="n">udfExampleDF</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">power3udf</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;num&quot;</span><span class="o">))).</span><span class="n">show</span><span class="o">()</span>

<span class="c1">// Register UDF as a Spark SQL function</span>
<span class="n">spark</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">register</span><span class="o">(</span><span class="s">&quot;power3&quot;</span><span class="o">,</span> <span class="n">power3</span><span class="o">(</span><span class="k">_:</span><span class="kt">Double</span><span class="o">)</span><span class="k">:</span><span class="kt">Double</span><span class="o">)</span>
<span class="n">udfExampleDF</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;power3(num)&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>

<span class="c1"># DataFrame</span>
<span class="n">udfExampleDF</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">)</span>

<span class="c1"># UDF power of 3</span>
<span class="k">def</span> <span class="nf">power3</span><span class="p">(</span><span class="n">double_value</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">double_value</span> <span class="o">**</span> <span class="mi">3</span>

<span class="n">power3</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

<span class="c1"># Register the UDF to make it available as a DataFrame Function</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="n">power3udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">power3</span><span class="p">)</span>

<span class="c1"># Use UDF as DataFrame function</span>
<span class="n">udfExampleDf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">power3udf</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Regiser UDf as a Spark SQL function</span>
<span class="n">spark</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">regiser</span><span class="p">(</span><span class="s2">&quot;power3&quot;</span><span class="p">,</span> <span class="n">power3</span><span class="p">)</span>
<span class="n">udfExampleDF</span><span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;power3(num)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>Hive UDFs：</p>
<blockquote>
<div><ul class="simple">
<li><p>You can user UDF/UDAF creation via a Hive syntax.</p>
<ul>
<li><p>First, must enable Hive support when they create their
SparkSession.</p></li>
<li><p>Then you register UDFs in SQL.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">SparkSession.builder().enableHiveSupport()</span></code></p></li>
</ul>
</div></blockquote>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">CREATE</span> <span class="k">TEMPORARY</span> <span class="k">FUNCTION</span> <span class="n">myFunc</span> <span class="k">AS</span> <span class="s1">&#39;com.organization.hive.udf.FunctionName&#39;</span>

<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">myFunc</span> <span class="k">AS</span> <span class="s1">&#39;com.organization.hive.udf.FunctionName&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="aggregations">
<span id="header-n719"></span><h4>2.4.28 Aggregations<a class="headerlink" href="#aggregations" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><ul class="simple">
<li><p>In an aggregation, you will specify a <code class="docutils literal notranslate"><span class="pre">key</span></code> or <code class="docutils literal notranslate"><span class="pre">grouping</span></code> and
an <code class="docutils literal notranslate"><span class="pre">aggregation</span> <span class="pre">function</span></code> that specifies how you should
transform one or more columns.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">aggregation</span> <span class="pre">function</span></code> must produce one result for each
group, given multiple input values；</p></li>
</ul>
</li>
<li><p>Spark can aggregate any kind of value into an <code class="docutils literal notranslate"><span class="pre">array</span></code>, <code class="docutils literal notranslate"><span class="pre">list</span></code>,
<code class="docutils literal notranslate"><span class="pre">map</span></code>；</p></li>
<li><p>Spark 聚合方式：</p>
<ul>
<li><p>select 语句</p></li>
<li><p>group by</p>
<ul>
<li><p>one or more keys</p></li>
<li><p>one or more aggregation function</p></li>
</ul>
</li>
<li><p>window</p>
<ul>
<li><p>one or more keys</p></li>
<li><p>one or more aggregation function</p></li>
</ul>
</li>
<li><p>group set</p>
<ul>
<li><p>aggregate at multiple different levels;</p></li>
</ul>
</li>
<li><p>rollup</p>
<ul>
<li><p>one or more keys</p></li>
<li><p>one or more aggregation function</p></li>
<li><p>summarized hierarchically</p></li>
</ul>
</li>
<li><p>cube</p>
<ul>
<li><p>one or more keys</p></li>
<li><p>one or more aggregation function</p></li>
<li><p>summarized across all combinations of columns</p></li>
</ul>
</li>
</ul>
</li>
<li><p>每个 grouping 返回一个 <code class="docutils literal notranslate"><span class="pre">RelationalGroupedDataset</span></code>
用来表示聚合(aggregation)；</p></li>
</ul>
</div></blockquote>
<p><strong>读入数据：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">df</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;csv&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;header&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">option</span><span class="o">(</span><span class="s">&quot;inferSchema&quot;</span><span class="o">,</span> <span class="s">&quot;true&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/retail-data/all/*.csv&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">coalesce</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="o">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;dfTable&quot;</span><span class="o">)</span>


<span class="c1">// 最简单的聚合</span>
<span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;csv&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;header&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;inferSchema&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/data/retail-data/all/*.csv&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;dfTable&quot;</span><span class="p">)</span>

<span class="c1"># 最简单的聚合</span>
<span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="aggregation-functions">
<span id="header-n776"></span><h5>2.4.28.1 Aggregation Functions<a class="headerlink" href="#aggregation-functions" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">org.apache.spark.sql.functions</span></code> or <code class="docutils literal notranslate"><span class="pre">pyspark.sql.functions</span></code></p>
<ul>
<li><p>count / countDistinct / approx<em>count</em>distinct</p></li>
<li><p>first / last</p></li>
<li><p>min / max</p></li>
<li><p>sum/sumDistinct</p></li>
<li><p>avg</p></li>
<li><p>Variance / Standard Deviation</p></li>
<li><p>skewness / kurtosis</p></li>
<li><p>Covariance/Correlation</p></li>
<li><p>Complex Types</p></li>
</ul>
</li>
</ul>
<p><strong>Transformation: count:</strong></p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">count(*)</span></code> 会对 null 计数；</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">count(&quot;OneColumn&quot;)</span></code> 不会对 null 计数；</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.count</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">count</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">)).</span><span class="n">show</span><span class="o">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">count</span><span class="o">(*)).</span><span class="n">show</span><span class="o">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">count</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">StockCode</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>

<span class="k">SELECT</span> <span class="n">COUTN</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>

<span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>countDistinct:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.countDistinct</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">countDistinct</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">countDistinct</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>approxcountdistinct:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.approx_count_distinct</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">approx_count_distinct</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">,</span> <span class="mf">0.1</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">approx_count_distinct</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">approx_count_distinct</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">approx_count_distinct</span><span class="p">(</span><span class="n">StockCode</span><span class="p">,</span> <span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>first and last:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">first</span><span class="o">,</span> <span class="n">last</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">first</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">),</span> <span class="n">last</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">first</span><span class="p">,</span> <span class="n">last</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">),</span> <span class="n">last</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="k">first</span><span class="p">(</span><span class="n">StockCode</span><span class="p">),</span>
    <span class="k">last</span><span class="p">(</span><span class="n">StockCode</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>min and max:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">min</span><span class="o">,</span> <span class="n">max</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">),</span> <span class="n">max</span><span class="o">(</span><span class="s">&quot;StockCode&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="s2">&quot;StockCode&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="k">min</span><span class="p">(</span><span class="n">StockCode</span><span class="p">),</span>
    <span class="k">max</span><span class="p">(</span><span class="n">StockCode</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>sum:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.sum</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">sum</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>sumDistinct</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.sumDistinct</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">sumDistinct</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">sumDistinct</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sumDistinct</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">sumDistinct</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>avg:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">sum</span><span class="o">,</span> <span class="n">count</span><span class="o">,</span> <span class="n">avg</span><span class="o">,</span> <span class="n">mean</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">count</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;total_transactions&quot;</span><span class="o">),</span>
    <span class="n">sum</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;total_pruchases&quot;</span><span class="o">),</span>
    <span class="n">avg</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;avg_purchases&quot;</span><span class="o">),</span>
    <span class="n">expr</span><span class="o">(</span><span class="s">&quot;mean(Quantity)&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;mean_purchases&quot;</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span>
    <span class="s">&quot;total_pruchases&quot;</span> <span class="o">/</span> <span class="s">&quot;total_transactions&quot;</span><span class="o">,</span>
    <span class="s">&quot;avg_purchases&quot;</span><span class="o">,</span>
    <span class="s">&quot;mean_purchases&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="c1">// Distinct version</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">countDistinct</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;total_transactions&quot;</span><span class="o">),</span>
    <span class="n">sumDistinct</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;total_pruchases&quot;</span><span class="o">),</span>
    <span class="n">avg</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;avg_purchases&quot;</span><span class="o">),</span>
    <span class="n">expr</span><span class="o">(</span><span class="s">&quot;mean(Quantity)&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;mean_purchases&quot;</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span>
    <span class="s">&quot;total_pruchases&quot;</span> <span class="o">/</span> <span class="s">&quot;total_transactions&quot;</span><span class="o">,</span>
    <span class="s">&quot;avg_purchases&quot;</span><span class="o">,</span>
    <span class="s">&quot;mean_purchases&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="nb">sum</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">avg</span><span class="p">,</span> <span class="n">mean</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">count</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;total_transactions&quot;</span><span class="p">),</span>
    <span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;total_pruchases&quot;</span><span class="p">),</span>
    <span class="n">avg</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;avg_purchases&quot;</span><span class="p">),</span>
    <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;mean(Quantity)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;mean_purchases&quot;</span><span class="p">)</span>
    <span class="p">)</span> \
  <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
    <span class="s2">&quot;total_pruchases&quot;</span> <span class="o">/</span> <span class="s2">&quot;total_transactions&quot;</span><span class="p">,</span>
    <span class="s2">&quot;avg_purchases&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mean_purchases&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Variance and Standard Deviation:</strong></p>
<ul class="simple">
<li><p>样本方差，样本标准差</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">var_samp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stddev_samp</span></code></p></li>
</ul>
</li>
<li><p>总体方差，总体标准差</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">var_pop</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stddev_pop</span></code></p></li>
</ul>
</li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">var_pop</span><span class="o">,</span> <span class="n">stddev_pop</span><span class="o">,</span> <span class="n">var_samp</span><span class="o">,</span> <span class="n">stddev_samp</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">var_pop</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">),</span>
    <span class="n">var_samp</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">),</span>
    <span class="n">stddev_pop</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">),</span>
    <span class="n">stddev_samp</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">var_pop</span><span class="p">,</span> <span class="n">stddev_pop</span><span class="p">,</span> <span class="n">var_samp</span><span class="p">,</span> <span class="n">stddev_samp</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">var_pop</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">var_samp</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">stddev_pop</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">stddev_samp</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">)</span>
    <span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">var_pop</span><span class="p">(</span><span class="ss">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">var_samp</span><span class="p">(</span><span class="ss">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">stddev_pop</span><span class="p">(</span><span class="ss">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">stddev_samp</span><span class="p">(</span><span class="ss">&quot;Quantity&quot;</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>skewness and kurtosis:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">skewness</span><span class="o">,</span> <span class="n">kurtosis</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">skewness</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">),</span>
    <span class="n">kurtosis</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">skewness</span><span class="p">,</span> <span class="n">kurtosis</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">skewness</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">kurtosis</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">skewness</span><span class="p">(</span><span class="n">Quantity</span><span class="p">),</span>
    <span class="n">kurtosis</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>Covariance and Correlation:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">corr</span><span class="o">,</span> <span class="n">covar_pop</span><span class="o">,</span> <span class="n">covar_samp</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="o">(</span>
    <span class="n">corr</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;Quantity&quot;</span><span class="o">),</span>
    <span class="n">covar_samp</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;Quantity&quot;</span><span class="o">),</span>
    <span class="n">covar_pop</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">,</span> <span class="s">&quot;Quantity&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">corr</span><span class="p">,</span> <span class="n">covar_pop</span><span class="p">,</span> <span class="n">covar_samp</span>
<span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
    <span class="n">corr</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">covar_samp</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">covar_pop</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">corr</span><span class="p">(</span><span class="ss">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="ss">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">covar_samp</span><span class="p">(</span><span class="ss">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="ss">&quot;Quantity&quot;</span><span class="p">),</span>
    <span class="n">covar_pop</span><span class="p">(</span><span class="ss">&quot;InvoiceNo&quot;</span><span class="p">,</span> <span class="ss">&quot;Quantity&quot;</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
<p><strong>Aggregation to Complex Types:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">collect_set</span><span class="o">,</span> <span class="n">collect_list</span><span class="o">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">agg</span><span class="o">(</span>
    <span class="n">collect_set</span><span class="o">(</span><span class="s">&quot;Country&quot;</span><span class="o">),</span>
    <span class="n">collect_list</span><span class="o">(</span><span class="s">&quot;Country&quot;</span><span class="o">)</span>
    <span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">collect_set</span><span class="p">,</span> <span class="n">collect_list</span>
<span class="n">df</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">collect_set</span><span class="p">(</span><span class="s2">&quot;Country&quot;</span><span class="p">),</span>
    <span class="n">collect_list</span><span class="p">(</span><span class="s2">&quot;Country&quot;</span><span class="p">)</span>
    <span class="p">)</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">collect_set</span><span class="p">(</span><span class="n">Country</span><span class="p">),</span>
    <span class="n">collect_list</span><span class="p">(</span><span class="n">Country</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
</pre></div>
</div>
</div>
<div class="section" id="grouping">
<span id="header-n873"></span><h5>2.4.28.2 Grouping<a class="headerlink" href="#grouping" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>First, specify the columns on which would like to group;</p>
<ul>
<li><p>return <code class="docutils literal notranslate"><span class="pre">RelationalGroupedDataset</span></code></p></li>
</ul>
</li>
<li><p>Then, specify the aggregation functions;</p>
<ul>
<li><p>return <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code></p></li>
</ul>
</li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;Invoice&quot;</span><span class="o">,</span> <span class="s">&quot;CustomerId&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">count</span><span class="o">()</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;Invoice&quot;</span><span class="p">,</span> <span class="s2">&quot;CustomerId&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">count</span><span class="p">()</span>
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">Invoice</span><span class="p">,</span>
    <span class="n">CustomId</span>
</pre></div>
</div>
<p id="header-n889">Grouping with Expression</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.count</span>

<span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">agg</span><span class="o">(</span>
    <span class="n">count</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;quan&quot;</span><span class="o">),</span>
    <span class="n">expr</span><span class="o">(</span><span class="s">&quot;count(Quantity)&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">count</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">count</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;quan&quot;</span><span class="p">),</span>
    <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;count(Quantity)&quot;</span><span class="p">))</span> \
  <span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p id="header-n892">Group with Maps</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;InvoiceNo&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">agg</span><span class="o">(</span>
    <span class="s">&quot;Quantity&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;avg&quot;</span><span class="o">,</span>
    <span class="s">&quot;Quantity&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;stddev_pop&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;InvoiceNo&quot;</span><span class="p">)</span> \
  <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
    <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;avg(Quantity)&quot;</span><span class="p">),</span>
    <span class="n">expr</span><span class="p">(</span><span class="s2">&quot;stddev_pop(Quantity)&quot;</span><span class="p">))</span> \
  <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="k">avg</span><span class="p">(</span><span class="n">Quantity</span><span class="p">),</span>
    <span class="n">stddev_pop</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">InvoiceNo</span>
</pre></div>
</div>
</div>
<div class="section" id="window-functions">
<span id="header-n896"></span><h5>2.4.28.3 Window Functions<a class="headerlink" href="#window-functions" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>ranking functions</p></li>
<li><p>analytic functions</p></li>
<li><p>aggregate functions</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">to_date</span><span class="o">}</span>

<span class="k">val</span> <span class="n">dfWithDate</span> <span class="k">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;date&quot;</span><span class="o">,</span> <span class="n">to_date</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;InvoiceDate&quot;</span><span class="o">),</span> <span class="s">&quot;MM/d/yyyy H:mm&quot;</span><span class="o">))</span>
<span class="n">dfWithDate</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;dfWithDate&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="n">to_date</span>
<span class="n">dfWithDate</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">to_date</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;InvoiceDate&quot;</span><span class="p">),</span> <span class="s2">&quot;MM/d/yyyy H:mm&quot;</span><span class="p">))</span>
<span class="n">dfWithDate</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;dfWithDate&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>示例：</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.</span><span class="o">{</span><span class="n">col</span><span class="o">,</span> <span class="n">max</span><span class="o">,</span> <span class="n">dense_rank</span><span class="o">,</span> <span class="n">rank</span><span class="o">}</span>

<span class="k">val</span> <span class="n">windowSpec</span> <span class="k">=</span> <span class="nc">Window</span>
    <span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="s">&quot;CustomerId&quot;</span><span class="o">,</span> <span class="s">&quot;date&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">).</span><span class="n">desc</span><span class="o">)</span>
    <span class="o">.</span><span class="n">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">))</span>

<span class="k">val</span> <span class="n">maxPurchaseQuantity</span> <span class="k">=</span> <span class="n">max</span><span class="o">(</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">)).</span><span class="n">over</span><span class="o">(</span><span class="n">windowSpec</span><span class="o">)</span>
<span class="k">val</span> <span class="n">purchaseDenseRank</span> <span class="k">=</span> <span class="n">dense_rank</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">windowSpec</span><span class="o">)</span>
<span class="k">val</span> <span class="n">purchaseRank</span> <span class="k">=</span> <span class="n">rank</span><span class="o">().</span><span class="n">over</span><span class="o">(</span><span class="n">windowSpec</span><span class="o">)</span>

<span class="n">dfWithDate</span>
    <span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;CustomerId IS NOT NULL&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;CustomerId&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">select</span><span class="o">(</span>
        <span class="n">col</span><span class="o">(</span><span class="s">&quot;CustomerId&quot;</span><span class="o">),</span>
        <span class="n">col</span><span class="o">(</span><span class="s">&quot;date&quot;</span><span class="o">),</span>
        <span class="n">col</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">),</span>
        <span class="n">purchaseRank</span><span class="o">.</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;quantityRank&quot;</span><span class="o">),</span>
        <span class="n">purchaseDenseRank</span><span class="o">.</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;quantityDenseRank&quot;</span><span class="o">),</span>
        <span class="n">maxPurchaseQuantity</span><span class="o">.</span><span class="n">alias</span><span class="o">(</span><span class="s">&quot;maxPurchaseQuantity&quot;</span><span class="o">))</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.expressions</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">dense_rank</span><span class="p">,</span> <span class="n">rank</span>

<span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span> \
    <span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s2">&quot;CustomerId&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">rowsBetween</span><span class="p">(</span><span class="n">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="p">,</span> <span class="n">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="p">)</span>

<span class="n">maxPurchaseQuantity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span>

<span class="n">purchaseDenseRank</span> <span class="o">=</span> <span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span>
<span class="n">purchaseRank</span> <span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span>

<span class="n">dfWithDate</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;CustomerId IS NOT NULL&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;CustomerId&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="n">col</span><span class="p">(</span><span class="s2">&quot;CustomerId&quot;</span><span class="p">),</span>
        <span class="n">col</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">),</span>
        <span class="n">col</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">),</span>
        <span class="n">purchaseRank</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;quantityRank&quot;</span><span class="p">),</span>
        <span class="n">purchaseDenseRank</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;quantityDenseRank&quot;</span><span class="p">),</span>
        <span class="n">maxPurchaseQuantity</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;maxPurchaseQuantity&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">CustomerId</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">Quantity</span><span class="p">,</span>
    <span class="n">rank</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span> <span class="n">over</span><span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="nb">date</span>
                        <span class="k">order</span> <span class="k">by</span> <span class="n">Quantity</span> <span class="k">desc</span> <span class="k">null</span> <span class="k">last</span>
                        <span class="k">rows</span> <span class="k">between</span>
                            <span class="n">unbounded</span> <span class="n">preceding</span> <span class="k">and</span>
                            <span class="k">current</span> <span class="k">row</span><span class="p">)</span> <span class="k">as</span> <span class="n">rank</span><span class="p">,</span>
    <span class="n">dense_rank</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span> <span class="n">over</span><span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="nb">date</span>
                              <span class="k">order</span> <span class="k">by</span> <span class="n">Quantity</span> <span class="k">desc</span> <span class="k">null</span> <span class="k">last</span>
                              <span class="k">rows</span> <span class="k">between</span>
                                  <span class="n">unbounded</span> <span class="n">preceding</span> <span class="k">and</span>
                                  <span class="n">urrent</span> <span class="k">row</span><span class="p">)</span> <span class="k">as</span> <span class="n">drank</span><span class="p">,</span>
    <span class="k">max</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span> <span class="n">over</span><span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">CustomerId</span><span class="p">,</span> <span class="nb">date</span>
                       <span class="k">order</span> <span class="k">by</span> <span class="n">Quantity</span> <span class="k">desc</span> <span class="k">null</span> <span class="k">last</span>
                       <span class="k">rows</span> <span class="k">between</span>
                           <span class="n">unbounded</span> <span class="n">preceding</span> <span class="k">and</span>
                           <span class="k">current</span> <span class="k">row</span><span class="p">)</span> <span class="k">as</span> <span class="n">maxPurchase</span>
<span class="k">FROM</span> <span class="n">dfTable</span>
<span class="k">WHERE</span> <span class="n">CustomerId</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">CustomerId</span>
</pre></div>
</div>
</div>
<div class="section" id="grouping-set">
<span id="header-n911"></span><h5>2.4.28.4 Grouping Set<a class="headerlink" href="#grouping-set" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>rollups</p></li>
<li><p>cube</p></li>
<li><p>Grouping Medadata</p></li>
<li><p>Pivot</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">dfNotNull</span> <span class="k">=</span> <span class="n">dfWithDate</span><span class="o">.</span><span class="n">drop</span><span class="o">()</span>
<span class="n">dfNotNull</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;dfNotNull&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">dfNotNull</span> <span class="o">=</span> <span class="n">dfWithDate</span><span class="o">.</span><span class="n">drop</span><span class="p">()</span>
<span class="n">dfNotNull</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;dfNotNull&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>示例：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">CustomerId</span><span class="p">,</span>
    <span class="n">stockCode</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfNotNull</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">CustomerId</span><span class="p">,</span>
    <span class="n">stockCode</span><span class="p">,</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">CustomerId</span> <span class="k">DESC</span><span class="p">,</span>
    <span class="n">stockCode</span> <span class="k">DESC</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">CustomerId</span><span class="p">,</span>
    <span class="n">stockCode</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfNotNull</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">CustomerId</span><span class="p">,</span>
    <span class="n">stockCode</span>
<span class="k">GROUPING</span> <span class="k">SETS</span><span class="p">((</span><span class="n">CustomerId</span><span class="p">,</span> <span class="n">stockCode</span><span class="p">))</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">CustomerId</span> <span class="k">DESC</span><span class="p">,</span>
    <span class="n">stockCode</span> <span class="k">DESC</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="n">CustomerId</span><span class="p">,</span>
    <span class="n">stockCode</span><span class="p">,</span>
    <span class="k">sum</span><span class="p">(</span><span class="n">Quantity</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">dfNotNull</span>
<span class="k">GROUP</span> <span class="k">BY</span>
    <span class="n">CustomerId</span><span class="p">,</span>
    <span class="n">stockCode</span>
<span class="k">GROUPING</span> <span class="k">SETS</span><span class="p">((</span><span class="n">CustomerId</span><span class="p">,</span> <span class="n">stockCode</span><span class="p">),</span> <span class="p">())</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">CustomerId</span> <span class="k">DESC</span><span class="p">,</span>
    <span class="n">stockCode</span> <span class="k">DESC</span>
</pre></div>
</div>
<p id="header-n928">2.4.28.4.1 Rollups</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">rolledUpDF</span> <span class="k">=</span> <span class="n">dfNotNull</span><span class="o">.</span><span class="n">rollup</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">,</span> <span class="s">&quot;Country&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">))</span>
    <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">,</span> <span class="s">&quot;Country&quot;</span><span class="o">,</span> <span class="s">&quot;`sum(Quantity)` as total_quantity&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">)</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;Country IS NULL&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;Date IS NULL&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">rolledUpDF</span> <span class="o">=</span> <span class="n">dfNotNull</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Country&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Country&quot;</span><span class="p">,</span> <span class="s2">&quot;`sum(Quantity)` as total_quantity&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;Country IS NULL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;Date IS NULL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p id="header-n931">2.4.28.4.1 Cube</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">rolledUpDF</span> <span class="k">=</span> <span class="n">dfNotNull</span><span class="o">.</span><span class="n">rollup</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">,</span> <span class="s">&quot;Country&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="o">(</span><span class="n">sum</span><span class="o">(</span><span class="s">&quot;Quantity&quot;</span><span class="o">))</span>
    <span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">,</span> <span class="s">&quot;Country&quot;</span><span class="o">,</span> <span class="s">&quot;`sum(Quantity)` as total_quantity&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">)</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">show</span><span class="o">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;Country IS NULL&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;Date IS NULL&quot;</span><span class="o">).</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">rolledUpDF</span> <span class="o">=</span> <span class="n">dfNotNull</span><span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Country&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&quot;Quantity&quot;</span><span class="p">))</span> \
    <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;Country&quot;</span><span class="p">,</span> <span class="s2">&quot;`sum(Quantity)` as total_quantity&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;Country IS NULL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">rolledUpDF</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;Date IS NULL&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p id="header-n935">2.4.28.4.1 Grouping Metadata</p>
<p id="header-n936">2.4.28.4.1 Pivot</p>
</div>
<div class="section" id="udf-aggregation-functions">
<span id="header-n939"></span><h5>2.4.28.5 UDF Aggregation Functions<a class="headerlink" href="#udf-aggregation-functions" title="Permalink to this headline">¶</a></h5>
</div>
</div>
<div class="section" id="joins">
<span id="header-n943"></span><h4>2.4.29 Joins<a class="headerlink" href="#joins" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Join Expression</p></li>
<li><p>Join Types</p>
<ul>
<li><p>Inner Join</p></li>
<li><p>Outer Join</p></li>
<li><p>Left outer join</p></li>
<li><p>Right outer join</p></li>
<li><p>Left semi join</p></li>
<li><p>Left anti join</p></li>
<li><p>Nature join</p></li>
<li><p>Cross join(Cartesian)</p></li>
</ul>
</li>
</ul>
<p><strong>数据：</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">person</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span>
    <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;Bill Chambers&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="mi">100</span><span class="o">)),</span>
    <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Matei Zaharia&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="mi">500</span><span class="o">,</span> <span class="mi">250</span><span class="o">,</span> <span class="mi">100</span><span class="o">)),</span>
    <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&quot;Michael Armbrust&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="mi">250</span><span class="o">,</span> <span class="mi">100</span><span class="o">))</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;graduate_program&quot;</span><span class="o">,</span> <span class="s">&quot;spark_status&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">graduateProgram</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;Master&quot;</span><span class="o">,</span> <span class="s">&quot;School of Information&quot;</span><span class="o">,</span> <span class="s">&quot;UC Berkeley&quot;</span><span class="o">),</span>
    <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&quot;Master&quot;</span><span class="o">,</span> <span class="s">&quot;EECS&quot;</span><span class="o">,</span> <span class="s">&quot;UC Berkeley&quot;</span><span class="o">),</span>
    <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Ph.D&quot;</span><span class="o">,</span> <span class="s">&quot;EECS&quot;</span><span class="o">,</span> <span class="s">&quot;UC Berkeley&quot;</span><span class="o">)</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;degree&quot;</span><span class="o">,</span> <span class="s">&quot;department&quot;</span><span class="o">,</span> <span class="s">&quot;school&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">sparkStatus</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
    <span class="o">(</span><span class="mi">500</span><span class="o">,</span> <span class="s">&quot;Vice President&quot;</span><span class="o">),</span>
    <span class="o">(</span><span class="mi">250</span><span class="o">,</span> <span class="s">&quot;PMC Member&quot;</span><span class="o">),</span>
    <span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="s">&quot;Contributor&quot;</span><span class="o">)</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;status&quot;</span><span class="o">)</span>

<span class="n">person</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;person&quot;</span><span class="o">)</span>
<span class="n">graduateProgram</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;graduateProgram&quot;</span><span class="o">)</span>
<span class="n">sparkStatus</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;sparkStatus&quot;</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Pyton</span>
<span class="n">person</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Bill Chambers&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">100</span><span class="p">]),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Matei Zaharia&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Michael Armbrust&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
    <span class="p">])</span> \
    <span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;graduate_program&quot;</span><span class="p">,</span> <span class="s2">&quot;spark_status&quot;</span><span class="p">)</span>

<span class="n">graduateProgram</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Master&quot;</span><span class="p">,</span> <span class="s2">&quot;School of Information&quot;</span><span class="p">,</span> <span class="s2">&quot;UC Berkeley&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Master&quot;</span><span class="p">,</span> <span class="s2">&quot;EECS&quot;</span><span class="p">,</span> <span class="s2">&quot;UC Berkeley&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Ph.D&quot;</span><span class="p">,</span> <span class="s2">&quot;EECS&quot;</span><span class="p">,</span> <span class="s2">&quot;UC Berkeley&quot;</span><span class="p">)</span>
    <span class="p">])</span> \
    <span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;degree&quot;</span><span class="p">,</span> <span class="s2">&quot;department&quot;</span><span class="p">,</span> <span class="s2">&quot;school&quot;</span><span class="p">)</span>

<span class="n">val</span> <span class="n">sparkStatus</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>
    <span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;Vice President&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="s2">&quot;PMC Member&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s2">&quot;Contributor&quot;</span><span class="p">)</span>
    <span class="p">])</span> \
    <span class="o">.</span><span class="n">toDF</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">)</span>

<span class="n">person</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;person&quot;</span><span class="p">)</span>
<span class="n">graduateProgram</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;graduateProgram&quot;</span><span class="p">)</span>
<span class="n">sparkStatus</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;sparkStatus&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="inner-join">
<span id="header-n970"></span><h5>2.4.29.1 Inner join<a class="headerlink" href="#inner-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">joinExpression</span> <span class="k">=</span> <span class="n">person</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;graduate_program&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="k">val</span> <span class="n">joinType</span> <span class="k">=</span> <span class="s">&quot;inner&quot;</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">joinExpression</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;graduate_program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>

<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
</div>
<div class="section" id="outer-join">
<span id="header-n974"></span><h5>2.4.29.2 Outer join<a class="headerlink" href="#outer-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">joinExpression</span> <span class="k">=</span> <span class="n">person</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;graduate_program&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">joinType</span> <span class="k">=</span> <span class="s">&quot;outer&quot;</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">joinExpression</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;graduate_program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;outer&quot;</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
</div>
<div class="section" id="left-outer-join">
<span id="header-n980"></span><h5>2.4.29.3 Left Outer join<a class="headerlink" href="#left-outer-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">joinExpression</span> <span class="k">=</span> <span class="n">person</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;graduate_program&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">joinType</span> <span class="k">=</span> <span class="s">&quot;left_outer&quot;</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">joinExpression</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;graduate_program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;left_outer&quot;</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
</div>
<div class="section" id="right-outer-join">
<span id="header-n984"></span><h5>2.4.29.4 Right Outer join<a class="headerlink" href="#right-outer-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">joinExpression</span> <span class="k">=</span> <span class="n">person</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;graduate_program&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">joinType</span> <span class="k">=</span> <span class="s">&quot;right_outer&quot;</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">joinExpression</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;graduate_program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;right_outer&quot;</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">RIGHT</span> <span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
</div>
<div class="section" id="left-semi-join">
<span id="header-n988"></span><h5>2.4.29.5 Left Semi join<a class="headerlink" href="#left-semi-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">joinExpression</span> <span class="k">=</span> <span class="n">person</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;graduate_program&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">joinType</span> <span class="k">=</span> <span class="s">&quot;left_semi&quot;</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="k">val</span> <span class="n">gradProgram2</span> <span class="k">=</span> <span class="n">graduateProgram</span>
    <span class="o">.</span><span class="n">union</span><span class="o">(</span>
        <span class="nc">Seq</span><span class="o">((</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;Master&quot;</span><span class="o">,</span> <span class="s">&quot;Duplicated Row&quot;</span><span class="o">,</span> <span class="s">&quot;Duplicated School&quot;</span><span class="o">))</span>
    <span class="o">)</span>
    <span class="o">.</span><span class="n">toDF</span><span class="o">()</span>
<span class="k">val</span> <span class="n">gradProgram2</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="o">(</span><span class="s">&quot;gradProgram2&quot;</span><span class="o">)</span>
<span class="n">gradProgram2</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">joinExpression</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;graduate_program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;left_semi&quot;</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">gradProgram2</span> <span class="o">=</span> <span class="n">graduateProgram</span>
    <span class="o">.</span><span class="n">union</span><span class="p">(</span>
        <span class="n">spark</span><span class="o">.</span><span class="n">crateDataFrame</span><span class="p">([(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Master&quot;</span><span class="p">,</span> <span class="s2">&quot;Duplicated Row&quot;</span><span class="p">,</span> <span class="s2">&quot;Duplicated School&quot;</span><span class="p">)])</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">toDF</span><span class="p">()</span>
<span class="n">val</span> <span class="n">gradProgram2</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;gradProgram2&quot;</span><span class="p">)</span>
<span class="n">gradProgram2</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">person</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>


<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">gradProgram2</span>
<span class="k">LEFT</span> <span class="n">SEMI</span> <span class="k">JOIN</span> <span class="n">person</span>
    <span class="k">ON</span> <span class="n">gradProgram2</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span>
</pre></div>
</div>
</div>
<div class="section" id="left-anti-join">
<span id="header-n992"></span><h5>2.4.29.6 Left Anti join<a class="headerlink" href="#left-anti-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">joinExpression</span> <span class="k">=</span> <span class="n">person</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;graduate_program&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">joinType</span> <span class="k">=</span> <span class="s">&quot;left_anti&quot;</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">joinExpression</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;graduate_program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;left_anti&quot;</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">LEFT</span> <span class="n">ANTI</span> <span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>
</pre></div>
</div>
</div>
<div class="section" id="natural-join">
<span id="header-n996"></span><h5>2.4.29.7 Natural join<a class="headerlink" href="#natural-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">NATURAL</span> <span class="k">JOIN</span> <span class="n">graduateProgram</span>
</pre></div>
</div>
</div>
<div class="section" id="cross-join">
<span id="header-n999"></span><h5>2.4.29.8 Cross join<a class="headerlink" href="#cross-join" title="Permalink to this headline">¶</a></h5>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// in Scala</span>
<span class="k">val</span> <span class="n">joinExpression</span> <span class="k">=</span> <span class="n">person</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;graduate_program&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">joinType</span> <span class="k">=</span> <span class="s">&quot;cross&quot;</span>
<span class="n">person</span>
    <span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">,</span> <span class="n">joinExpression</span><span class="o">,</span> <span class="n">joinType</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>

<span class="n">person</span>
    <span class="o">.</span><span class="n">crossJoin</span><span class="o">(</span><span class="n">graduateProgram</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in Python</span>
<span class="n">joinExpression</span> <span class="o">=</span> <span class="n">person</span><span class="p">[</span><span class="s2">&quot;graduate_program&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">graduateProgram</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="n">joinType</span> <span class="o">=</span> <span class="s2">&quot;cross&quot;</span>
<span class="n">person</span> \
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">,</span> <span class="n">joinExpression</span><span class="p">,</span> <span class="n">joinType</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">person</span> \
    <span class="o">.</span><span class="n">crossJoin</span><span class="p">(</span><span class="n">graduateProgram</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- in SQL</span>
<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">person</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">graduateProgram</span>
    <span class="k">ON</span> <span class="n">person</span><span class="p">.</span><span class="n">graduate_program</span> <span class="o">=</span> <span class="n">graduateProgram</span><span class="p">.</span><span class="n">id</span>

<span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span> <span class="n">graduateProgram</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="n">person</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="sql">
<span id="header-n1008"></span><h2>3.SQL<a class="headerlink" href="#sql" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tables">
<span id="header-n1009"></span><h3>3.1 表 (tables)<a class="headerlink" href="#tables" title="Permalink to this headline">¶</a></h3>
<div class="section" id="spark-sql">
<span id="header-n1010"></span><h4>3.1.1 Spark SQL 创建表<a class="headerlink" href="#spark-sql" title="Permalink to this headline">¶</a></h4>
<p>读取 flight data 并创建为一张表：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">flights</span> <span class="p">(</span>
    <span class="n">DEST_COUNTRY_NAME</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">ORIGIN_COUNTRY_NAME</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">COUNTS</span> <span class="n">LONG</span>
<span class="p">)</span>
<span class="k">USING</span> <span class="n">JSON</span> <span class="k">OPTIONS</span> <span class="p">(</span><span class="n">path</span> <span class="ss">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">flights</span> <span class="p">(</span>
    <span class="n">DEST_COUNTRY_NAME</span> <span class="n">STRING</span><span class="p">,</span>
    <span class="n">ORIGIN_COUNTRY_NAME</span> <span class="n">STRING</span> <span class="ss">&quot;remember, the US will be most prevalent&quot;</span><span class="p">,</span>
    <span class="n">COUNTS</span> <span class="n">LONG</span>
<span class="p">)</span>
<span class="k">USING</span> <span class="n">JSON</span> <span class="k">OPTIONS</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="ss">&quot;/data/flight-dat/json/2015-summary.json&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">flights_from_select</span> <span class="k">USING</span> <span class="n">parquet</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">flights</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="n">TALBE</span> <span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="n">flights_from_select</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">flights</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">partitioned_flights</span> <span class="k">USING</span> <span class="n">parquet</span> <span class="n">PARTITION</span> <span class="k">BY</span> <span class="p">(</span><span class="n">DEST_COUNTRY_NAME</span><span class="p">)</span> <span class="k">AS</span>
<span class="k">SELECT</span>
    <span class="n">DEST_COUNTRY_NAME</span><span class="p">,</span>
    <span class="n">ORIGIN_COUNTRY_NAME</span><span class="p">,</span>
    <span class="n">COUNTS</span>
<span class="k">FROM</span> <span class="n">flights</span>
<span class="k">LIMIT</span> <span class="mi">5</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n1018">
<span id="id10"></span><h4>3.1.2 Spark SQL 创建外部表<a class="headerlink" href="#header-n1018" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="header-n1019">
<span id="id11"></span><h4>3.1.3 Spark SQL 插入表<a class="headerlink" href="#header-n1019" title="Permalink to this headline">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">flights_from_select</span>
<span class="k">SELECT</span>
    <span class="n">DEST_COUNTRY_NAME</span><span class="p">,</span>
    <span class="n">ORIGIN_COUNTRY_NAME</span><span class="p">,</span>
    <span class="n">COUNTS</span>
<span class="k">FROM</span> <span class="n">flights</span>
<span class="k">LIMIT</span> <span class="mi">20</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">partitioned_flights</span>
<span class="n">PARTITION</span> <span class="p">(</span><span class="n">DEST_COUNTRY_NAME</span><span class="o">=</span><span class="ss">&quot;UNITED STATES&quot;</span><span class="p">)</span>
<span class="k">SELECT</span>
    <span class="n">COUNTS</span><span class="p">,</span>
    <span class="n">ORIGIN_COUNTRY_NAME</span>
<span class="k">FROM</span> <span class="n">flights</span>
<span class="k">WHERE</span> <span class="n">DEST_COUNTRY_NAME</span><span class="o">=</span><span class="ss">&quot;UNITED STATES&quot;</span>
<span class="k">LIMIT</span> <span class="mi">12</span>
</pre></div>
</div>
</div>
<div class="section" id="spark-sql-describing-matadata">
<span id="header-n1024"></span><h4>3.1.4 Spark SQL Describing 表 Matadata<a class="headerlink" href="#spark-sql-describing-matadata" title="Permalink to this headline">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DESCRIBE</span> <span class="k">TABLE</span> <span class="n">flights_csv</span>
</pre></div>
</div>
</div>
<div class="section" id="spark-sql-refreshing-matadata">
<span id="header-n1026"></span><h4>3.1.5 Spark SQL Refreshing 表 Matadata<a class="headerlink" href="#spark-sql-refreshing-matadata" title="Permalink to this headline">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">REFRESH</span> <span class="k">TABLE</span> <span class="n">partitioned_flights</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">MSCK</span> <span class="n">REPAIR</span> <span class="k">TABLE</span> <span class="n">partitioned_flights</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n1030">
<span id="id12"></span><h4>3.1.6 Spark SQL 删除表<a class="headerlink" href="#header-n1030" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>当删除管理表(managed table)时，表中的数据和表的定义都会被删除；</p>
</div></blockquote>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">flights_csv</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">flights_csv</span><span class="p">;</span>
</pre></div>
</div>
<blockquote>
<div><p>当删除非管理表时，表中的数据不会被删除，但是不能够再引用原来表的名字对表进行操作；</p>
</div></blockquote>
</div>
<div class="section" id="caching">
<span id="header-n1038"></span><h4>3.1.7 Caching 表<a class="headerlink" href="#caching" title="Permalink to this headline">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CACHE</span> <span class="k">TABLE</span> <span class="n">flights</span>
<span class="n">UNCACHE</span> <span class="k">TABLE</span> <span class="n">flights</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="views">
<span id="header-n1042"></span><h3>3.2 视图 (views)<a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>A view specifies a set of transformations on top of an existing
table-basically just saved query plans, which cna be convenient
for organizing or resuing query logic.</p></li>
<li><p>A view is effectively a transformation and Spark will perform it
only at query time, views are equivalent to create a new DataFrame
from an existing DataFrame.</p></li>
</ul>
</div></blockquote>
<div class="section" id="header-n1049">
<span id="id13"></span><h4>3.2.1 创建视图<a class="headerlink" href="#header-n1049" title="Permalink to this headline">¶</a></h4>
<p>创建 View:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">just_usa_view</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">flights</span>
<span class="k">WHERE</span> <span class="n">DEST_COUNTRY_NAME</span> <span class="o">=</span> <span class="s1">&#39;UNITED STATES&#39;</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="n">TEMP</span> <span class="k">VIEW</span> <span class="n">just_usa_view_temp</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">flights</span>
<span class="k">WHERE</span> <span class="n">DEST_COUNTRY_NAME</span> <span class="o">=</span> <span class="ss">&quot;UNITED STATES&quot;</span>
</pre></div>
</div>
<p>创建临时 View:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="n">TEMP</span> <span class="k">VIEW</span> <span class="n">just_usa_view_temp</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">flights</span>
<span class="k">WHERE</span> <span class="n">DEST_COUNTRY_NAME</span> <span class="o">=</span> <span class="ss">&quot;UNITED STATES&quot;</span>
</pre></div>
</div>
<p>创建全局临时 View:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">GLOBAL</span> <span class="n">TEMP</span> <span class="k">VIEW</span> <span class="n">just_usa_global_view_temp</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">flights</span>
<span class="k">WHERE</span> <span class="n">DEST_COUNTRY_NAME</span> <span class="o">=</span> <span class="ss">&quot;UNITED STATES&quot;</span>

<span class="k">SHOW</span> <span class="n">TABLES</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n1057">
<span id="id14"></span><h4>3.2.2 删除视图<a class="headerlink" href="#header-n1057" title="Permalink to this headline">¶</a></h4>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">VIEW</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">just_usa_view</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="dataframe-view">
<span id="header-n1059"></span><h4>3.2.3 DataFrame 和 View<a class="headerlink" href="#dataframe-view" title="Permalink to this headline">¶</a></h4>
<p><strong>DataFrame:</strong></p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">flights</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="s">&quot;json&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">load</span><span class="o">(</span><span class="s">&quot;/data/flight-data/json/2015-summary.json&quot;</span><span class="o">)</span>

<span class="k">val</span> <span class="n">just_usa_df</span> <span class="k">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class="s">&quot;dest_country_name = &#39;United States&#39;&quot;</span><span class="o">)</span>

<span class="n">just_usa_df</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;*&quot;</span><span class="o">).</span><span class="n">explain</span>
</pre></div>
</div>
<p><strong>View:</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXPLAIN</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">just_usa_view</span>
<span class="k">EXPLAIN</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">flights</span> <span class="k">WHERE</span> <span class="n">dest_country_name</span> <span class="o">=</span> <span class="ss">&quot;United States&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="databases">
<span id="header-n1065"></span><h3>3.3 数据库 (databases)<a class="headerlink" href="#databases" title="Permalink to this headline">¶</a></h3>
<div class="section" id="header-n1066">
<span id="id15"></span><h4>3.3.1 创建数据库<a class="headerlink" href="#header-n1066" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="header-n1067">
<span id="id16"></span><h4>3.3.2 配置数据库<a class="headerlink" href="#header-n1067" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="header-n1068">
<span id="id17"></span><h4>3.3.3 删除数据库<a class="headerlink" href="#header-n1068" title="Permalink to this headline">¶</a></h4>
</div>
</div>
<div class="section" id="header-n1070">
<span id="id18"></span><h3>3.4 数据查询语句<a class="headerlink" href="#header-n1070" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>ANSI SQL</p>
</div></blockquote>
<p><strong>(1) 查询语句</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="p">[</span><span class="k">ALL</span><span class="o">|</span><span class="n">DESTINCT</span><span class="p">]</span>
    <span class="n">named_expression</span><span class="p">[,</span> <span class="n">named_expression</span><span class="p">,</span> <span class="p">...]</span>
<span class="k">FROM</span> <span class="n">relation</span><span class="p">[,</span> <span class="n">relation</span><span class="p">,</span> <span class="p">...]</span>
     <span class="p">[</span><span class="n">lateral_view</span><span class="p">[,</span> <span class="n">lateral_view</span><span class="p">,</span> <span class="p">...]]</span>
<span class="p">[</span><span class="k">WHERE</span> <span class="n">boolean_expression</span><span class="p">]</span>
<span class="p">[</span><span class="n">aggregation</span> <span class="p">[</span><span class="k">HAVING</span> <span class="n">boolean_expression</span><span class="p">]]</span>
<span class="p">[</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">sort_expression</span><span class="p">]</span>
<span class="p">[</span><span class="k">CLUSTER</span> <span class="k">BY</span> <span class="n">expression</span><span class="p">]</span>
<span class="p">[</span><span class="n">DISTRIBUTE</span> <span class="k">BY</span> <span class="n">expression</span><span class="p">]</span>
<span class="p">[</span><span class="n">SORT</span> <span class="k">BY</span> <span class="n">sort_expression</span><span class="p">]</span>
<span class="p">[</span><span class="n">WINDOW</span> <span class="n">named_window</span><span class="p">[,</span> <span class="n">WINDOW</span> <span class="n">named_window</span><span class="p">,</span> <span class="p">...]]</span>
<span class="p">[</span><span class="k">LIMIT</span> <span class="n">num_rows</span><span class="p">]</span>
</pre></div>
</div>
<p>其中：</p>
<ul class="simple">
<li><p>named_expression:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">expression</span> <span class="pre">[AS</span> <span class="pre">alias]</span></code></p></li>
</ul>
</li>
<li><p>relation:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">join_relation</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(table_name|query|relation)</span> <span class="pre">[sample]</span> <span class="pre">[AS</span> <span class="pre">alias]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VALUES</span> <span class="pre">(expression)[,</span> <span class="pre">(expressions),</span> <span class="pre">...]</span> <span class="pre">[AS</span> <span class="pre">(column_name[,</span> <span class="pre">column_name,</span> <span class="pre">...])]</span></code></p></li>
</ul>
</li>
<li><p>expression:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">expression[,</span> <span class="pre">expression]</span></code></p></li>
</ul>
</li>
<li><p>sort_expression:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">expression</span> <span class="pre">[ASC|DESC][,</span> <span class="pre">expression</span> <span class="pre">[ASC|DESC],</span> <span class="pre">...]</span></code></p></li>
</ul>
</li>
</ul>
<p><strong>(2) CASE…WHEN…THEN…ELSE…END 语句</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">DEST_COUNTRY_NAME</span> <span class="o">=</span> <span class="s1">&#39;UNITED STATES&#39;</span> <span class="k">THEN</span> <span class="mi">1</span>
         <span class="k">WHEN</span> <span class="n">DEST_COUNTRY_NAME</span> <span class="o">=</span> <span class="s1">&#39;Egypt&#39;</span> <span class="k">THEN</span> <span class="mi">0</span>
         <span class="k">ELSE</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">END</span>
<span class="k">FROM</span> <span class="n">partitioned_flights</span>
</pre></div>
</div>
</div>
<div class="section" id="header-n1104">
<span id="id19"></span><h3>3.5 其他<a class="headerlink" href="#header-n1104" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="dataset">
<span id="header-n1106"></span><h2>4.DataSet<a class="headerlink" href="#dataset" title="Permalink to this headline">¶</a></h2>
<p>DataSet 的使用场景:</p>
<div class="section" id="header-n1108">
<span id="id20"></span><h3>4.1 创建 DataSet<a class="headerlink" href="#header-n1108" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>创建一个 DataSet 是一个纯手工操作，需要事先知道并且定义数据的 schema;</p>
</div></blockquote>
<div class="section" id="java-encoders">
<span id="header-n1111"></span><h4>Java: <code class="docutils literal notranslate"><span class="pre">Encoders</span></code><a class="headerlink" href="#java-encoders" title="Permalink to this headline">¶</a></h4>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.apache.spark.sql.Encoders</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Flight</span> <span class="kd">implements</span> <span class="n">Serializable</span><span class="p">{</span>
    <span class="n">String</span> <span class="n">DEST_COUNTRY_NAME</span><span class="p">;</span>
    <span class="n">String</span> <span class="n">ORIGIN_COUNTRY_NAME</span><span class="p">;</span>
    <span class="n">Long</span> <span class="n">DEST_COUNTRY_NAME</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DataSet</span><span class="o">&lt;</span><span class="n">Flight</span><span class="o">&gt;</span> <span class="n">flights</span> <span class="o">=</span> <span class="n">spark</span><span class="p">.</span><span class="na">read</span>
    <span class="p">.</span><span class="na">parquet</span><span class="p">(</span><span class="s">&quot;/data/flight-data/parquet/2010-summary.parquet/&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="na">as</span><span class="p">(</span><span class="n">Encoders</span><span class="p">.</span><span class="na">bean</span><span class="p">(</span><span class="n">Flight</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="scala-case-class">
<span id="header-n1113"></span><h4>Scala: <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code><a class="headerlink" href="#scala-case-class" title="Permalink to this headline">¶</a></h4>
<p>Scala <code class="docutils literal notranslate"><span class="pre">case</span> <span class="pre">class</span></code> 的特征：</p>
<ul class="simple">
<li><p>不可变(Immutable)</p></li>
<li><p>通过模式匹配可分解(Decomposable through pattern matching)</p></li>
<li><p>允许基于结构而不是参考进行比较(Allows for comparision based on
structrue instead of reference)</p></li>
<li><p>易用、易操作(Easy to use and manipulate)</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="c1">// 定义 DataSet Flight 的 schema</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Flight</span><span class="o">(</span>
    <span class="nc">DEST_COUNTRY_NAME</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="nc">ORIGIN_COUNTRY_NAME</span><span class="k">:</span> <span class="kt">Stringf</span><span class="o">,</span>
    <span class="n">count</span><span class="k">:</span> <span class="kt">BigInt</span>
<span class="o">)</span>

<span class="k">val</span> <span class="n">flightsDF</span> <span class="k">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span>
    <span class="o">.</span><span class="n">parquet</span><span class="o">(</span><span class="s">&quot;/data/flight-data/parquet/2010-summary.parquet/&quot;</span><span class="o">)</span>
<span class="k">val</span> <span class="n">flights</span> <span class="k">=</span> <span class="n">flightsDF</span><span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">Flight</span><span class="o">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="actions">
<span id="header-n1126"></span><h3>4.2 Actions<a class="headerlink" href="#actions" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>DataFrame 上的 Action 操作也对 DataSet 有效;</p>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="n">flights</span><span class="o">.</span><span class="n">collect</span><span class="o">()</span>
<span class="n">flights</span><span class="o">.</span><span class="n">take</span><span class="o">()</span>
<span class="n">flights</span><span class="o">.</span><span class="n">count</span><span class="o">()</span>

<span class="n">flights</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span>
</pre></div>
</div>
</div>
<div class="section" id="transformations">
<span id="header-n1131"></span><h3>4.3 Transformations<a class="headerlink" href="#transformations" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>DataFrame 上的 Transformation 操作也对 DataSet 有效;</p></li>
<li><p>除了 DataFrame 上的 Transformation，DataSet
上也有更加复杂和强类型的 Transformation 操作，因为，操作 DataSet
相当于操作的是原始的 Java Virtual Machine (JVM) 类型.</p></li>
</ul>
</div></blockquote>
<div class="section" id="dataframe-transformation">
<span id="header-n1138"></span><h4>DataFrame 上的 Transformation 操作<a class="headerlink" href="#dataframe-transformation" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="dataset-transformation">
<span id="header-n1140"></span><h4>DataSet 特有的 Transformation 操作<a class="headerlink" href="#dataset-transformation" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Filtering</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">originIsDestination</span><span class="o">(</span><span class="n">flight_row</span><span class="k">:</span> <span class="kt">Flight</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">flight_row</span><span class="o">.</span><span class="nc">ORIGIN_COUNTRY_NAME</span> <span class="o">==</span> <span class="n">flight_row</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span>
<span class="o">}</span>


<span class="n">flights</span>
    <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">flight_row</span> <span class="k">=&gt;</span> <span class="n">originIsDestination</span><span class="o">(</span><span class="n">flight_row</span><span class="o">))</span>
    <span class="o">.</span><span class="n">first</span><span class="o">()</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Mapping</p></li>
</ul>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">destinations</span> <span class="k">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span> <span class="k">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">)</span>
<span class="k">val</span> <span class="n">localDestinations</span> <span class="k">=</span> <span class="n">destinations</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="header-n1149">
<span id="id21"></span><h3>4.4 Joins<a class="headerlink" href="#header-n1149" title="Permalink to this headline">¶</a></h3>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">FlightMetadata</span><span class="o">(</span>
    <span class="n">count</span><span class="k">:</span> <span class="kt">BigInt</span><span class="o">,</span>
    <span class="n">randomData</span><span class="k">:</span> <span class="kt">BigInt</span>
<span class="o">)</span>

<span class="k">val</span> <span class="n">flightsMeta</span> <span class="k">=</span> <span class="n">spark</span>
    <span class="o">.</span><span class="n">range</span><span class="o">(</span><span class="mi">500</span><span class="o">)</span>
    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">scala</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextLong</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="o">(</span><span class="s">&quot;_1&quot;</span><span class="o">,</span> <span class="s">&quot;count&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="o">(</span><span class="s">&quot;_2&quot;</span><span class="o">,</span> <span class="s">&quot;randomData&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">FlightMetadata</span><span class="o">]</span>

<span class="k">val</span> <span class="n">flights2</span> <span class="k">=</span> <span class="n">flights</span>
    <span class="o">.</span><span class="n">joinWith</span><span class="o">(</span><span class="n">flightsMeta</span><span class="o">,</span> <span class="n">flights</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">)</span> <span class="o">===</span> <span class="n">flightsMeta</span><span class="o">.</span><span class="n">col</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">))</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">flights2</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="s">&quot;_1.DEST_COUNTRY_NAME&quot;</span><span class="o">)</span>
<span class="n">flights2</span><span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="k">val</span> <span class="n">flights2</span> <span class="k">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">flightsMeta</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">flights2</span> <span class="k">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">flightsMeta</span><span class="o">.</span><span class="n">toDF</span><span class="o">(),</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">))</span>
<span class="k">val</span> <span class="n">flights2</span> <span class="k">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">join</span><span class="o">(</span><span class="n">flightsMeta</span><span class="o">.</span><span class="n">toDF</span><span class="o">(),</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&quot;count&quot;</span><span class="o">))</span>
</pre></div>
</div>
</div>
<div class="section" id="grouping-and-aggregations">
<span id="header-n1152"></span><h3>4.5 Grouping and Aggregations<a class="headerlink" href="#grouping-and-aggregations" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>DataSet 中的 Grouping 和 Aggregation 跟 DataFrame 中的 Grouping 和
Aggregation 一样的用法，因此，<code class="docutils literal notranslate"><span class="pre">groupBy</span></code>, <code class="docutils literal notranslate"><span class="pre">rollup</span></code> 和
<code class="docutils literal notranslate"><span class="pre">cube</span></code> 对 DataSet 依然有效，只不过不再返回 DataFrame，而是返回
DataSet，实际上是丢弃了 type 信息.</p></li>
<li><p>如果想要保留 type
信息，有一些方法可以实现，比如：<code class="docutils literal notranslate"><span class="pre">groupByKey</span></code>，<code class="docutils literal notranslate"><span class="pre">groupByKey</span></code>
可以通过 group 一个特殊的 DataSet key，然后返回带有 type 信息的
DataSet；但是 <code class="docutils literal notranslate"><span class="pre">groupByKey</span></code> 不再接受一个具体的 column
名字，而是一个函数，这样使得可以使用一些更加特殊的聚合函数来对数据进行聚合。但是这样做虽然灵活，却失去了性能上的优势。</p></li>
</ul>
</div></blockquote>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">).</span><span class="n">count</span><span class="o">()</span>
<span class="n">flights</span><span class="o">.</span><span class="n">groupByKey</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">).</span><span class="n">count</span><span class="o">()</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">groupByKey</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">).</span><span class="n">count</span><span class="o">().</span><span class="n">explain</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">grpSum</span><span class="o">(</span><span class="n">countryName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">values</span><span class="k">:</span> <span class="kt">Iterator</span><span class="o">[</span><span class="kt">Flight</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">values</span><span class="o">.</span><span class="n">dropWhile</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">countryName</span><span class="o">,</span> <span class="n">x</span><span class="o">))</span>
<span class="o">}</span>
<span class="n">flights</span>
    <span class="o">.</span><span class="n">groupByKey</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">)</span>
    <span class="o">.</span><span class="n">flatMapGroups</span><span class="o">(</span><span class="n">grpSum</span><span class="o">)</span>
    <span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">grpSum2</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Flight</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="mi">1</span>
<span class="o">}</span>
<span class="n">flights2</span>
    <span class="o">.</span><span class="n">groupByKey</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">)</span>
    <span class="o">.</span><span class="n">mapValues</span><span class="o">(</span><span class="n">grpSum2</span><span class="o">)</span>
    <span class="o">.</span><span class="n">count</span><span class="o">()</span>
    <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">sum2</span><span class="o">(</span><span class="n">left</span><span class="k">:</span> <span class="kt">Flight</span><span class="o">,</span> <span class="n">right</span><span class="k">:</span> <span class="kt">Flight</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Flight</span><span class="o">(</span><span class="n">left</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">left</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">count</span><span class="o">)</span>
<span class="o">}</span>

<span class="n">flights</span>
    <span class="o">.</span><span class="n">groupByKey</span><span class="o">(</span><span class="n">x</span> <span class="k">=&gt;</span> <span class="n">x</span><span class="o">.</span><span class="nc">DEST_COUNTRY_NAME</span><span class="o">)</span>
    <span class="o">.</span><span class="n">reduceGroups</span><span class="o">((</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">sum2</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">))</span>
</pre></div>
</div>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="n">flights</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="s">&quot;DEST_COUNTRY_NAME&quot;</span><span class="o">).</span><span class="n">count</span><span class="o">().</span><span class="n">explain</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="SparkSQL.html" class="btn btn-neutral float-right" title="Spark SQL" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Spark-Introduction.html" class="btn btn-neutral float-left" title="Spark 介绍" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, wangzf

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>